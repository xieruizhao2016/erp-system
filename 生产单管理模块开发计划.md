# ERP 生产单管理模块开发工作计划

## 📋 项目概述

### 模块名称：生产单管理 (Production Order Management)
### 主要功能：生产订单的全生命周期管理，从接单到完成的完整流程跟踪
### 开发周期：预计 15-20 个工作日
### 开发分支：feature/production-order-management

---

## 🎯 功能需求分析

### 1. 核心业务流程
```
已接单 → 待排产 → 配件采购中 → 生产中 → 包装中 → 生产完成-待销售 → 销售中 → 已完成
                                                    ↓
                                               已取消（手动）
```

### 2. 状态管理规则
- **已接单**：创建生产单时的默认状态
- **待排产**：手动修改，需验证源材料库存充足
- **配件采购中**：采购订单关联生产单时自动变更
- **生产中**：源材料出库关联生产单时自动变更
- **包装中**：半成品入库关联生产单时自动变更
- **生产完成-待销售**：成品入库关联生产单时自动变更
- **销售中**：销售订单关联生产单时自动变更
- **已完成**：收款单关联生产单时自动变更
- **已取消**：手动管理

### 3. 业务规则
- 不支持删除生产单，只能修改状态
- 源材料库存不足时，禁止变更为"待排产"状态
- 状态流转需严格按照业务规则执行
- 所有状态变更需记录操作日志

---

## 🏗️ 技术架构设计

### 1. 后端架构
```
yudao-module-erp/
├── controller/admin/production/           # 控制器
│   ├── ErpProductionOrderController.java # 生产单主控制器
│   └── vo/                               # 视图对象
│       ├── ErpProductionOrderPageReqVO.java
│       ├── ErpProductionOrderSaveReqVO.java
│       ├── ErpProductionOrderRespVO.java
│       └── ErpProductionOrderStatusReqVO.java
├── service/production/                   # 服务层
│   ├── ErpProductionOrderService.java
│   ├── impl/ErpProductionOrderServiceImpl.java
│   └── bo/                               # 业务对象
│       ├── ErpProductionOrderSaveReqBO.java
│       └── ErpProductionOrderStatusChangeBO.java
├── dal/mysql/production/                 # 数据访问层
│   ├── ErpProductionOrderMapper.java
│   ├── ErpProductionOrderItemMapper.java
│   └── dataobject/                       # 数据对象
│       ├── ErpProductionOrderDO.java
│       └── ErpProductionOrderItemDO.java
├── convert/production/                   # 转换器
│   └── ErpProductionOrderConvert.java
└── enums/                               # 枚举
    └── ErpProductionOrderStatus.java
```

### 2. 前端架构
```
original-yudao-ui/src/views/erp/production/
├── order/                               # 生产单管理
│   ├── index.vue                       # 生产单列表页
│   ├── OrderForm.vue                   # 新增/编辑生产单
│   ├── OrderDetail.vue                 # 生产单详情
│   └── components/
│       ├── ProductionStatusSelector.vue # 状态选择器
│       ├── MaterialSelector.vue        # 材料选择器
│       └── ProductSelector.vue         # 产品选择器
├── components/                          # 公共组件
│   └── ProductionOrderSelector.vue     # 生产单选择组件
└── api/production/                      # API接口
    └── order/
        └── index.ts
```

---

## 📊 数据库设计

### 1. 主要数据表

#### 生产单主表 (erp_production_order)
```sql
CREATE TABLE `erp_production_order` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '生���单ID',
  `no` varchar(50) NOT NULL COMMENT '生产单号',
  `status` int NOT NULL DEFAULT 10 COMMENT '生产单状态',
  `customer_id` bigint COMMENT '客户ID',
  `order_date` datetime NOT NULL COMMENT '下单日期',
  `contract_no` varchar(50) COMMENT '采购单号/合同编号',
  `total_count` decimal(20,2) NOT NULL COMMENT '总数量',
  `total_price` decimal(20,2) NOT NULL COMMENT '总价',
  `delivery_date` datetime COMMENT '交货日期',
  `remark` varchar(500) COMMENT '备注',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint(1) DEFAULT '0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_no` (`no`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_status` (`status`),
  KEY `idx_order_date` (`order_date`)
) COMMENT='生产订单表';
```

#### 生产单明细表 (erp_production_order_item)
```sql
CREATE TABLE `erp_production_order_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '明细ID',
  `production_order_id` bigint NOT NULL COMMENT '生产单ID',
  `item_type` int NOT NULL COMMENT '项目类型：1-源材料，2-成品',
  `product_id` bigint NOT NULL COMMENT '产品ID',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `product_sku` varchar(50) NOT NULL COMMENT '产品SKU',
  `count` decimal(20,2) NOT NULL COMMENT '数量',
  `unit_price` decimal(20,2) COMMENT '单价',
  `total_price` decimal(20,2) COMMENT '总价',
  `remark` varchar(500) COMMENT '备注',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint(1) DEFAULT '0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_production_order_id` (`production_order_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_item_type` (`item_type`)
) COMMENT='生产订单明细表';
```

#### 产品表扩展字段
```sql
ALTER TABLE `erp_product` ADD COLUMN `production_type` int DEFAULT 1 COMMENT '生产类型：1-普通产品，2-源材料，3-成品';
```

### 2. 状态枚举定义
```java
public enum ErpProductionOrderStatus {
    RECEIVED(10, "已接单"),
    PENDING_SCHEDULE(20, "待排产"),
    PURCHASING(30, "配件采购中"),
    IN_PRODUCTION(40, "生产中"),
    PACKAGING(50, "包装中"),
    READY_FOR_SALE(60, "生产完成-待销售"),
    IN_SALES(70, "销售中"),
    COMPLETED(80, "已完成"),
    CANCELLED(90, "已取消");

    private final Integer status;
    private final String name;

    // 构造函数、getter方法等
}
```

---

## 🛠️ 开发阶段计划

### 第一阶段：基础架构搭建 (3-4天)

#### Day 1: 数据库设计和创建
- [ ] 创建生产单主表
- [ ] 创建生产单明细表
- [ ] 产品表添加生产类型字段
- [ ] 创建基础索引和约束
- [ ] 编写数据表创建脚本
- [ ] 插入基础测试数据

**交付物**：
- `sql/mysql/production-order-tables.sql`
- 测试数据脚本

#### Day 2: 后端基础框架 - DO对象
- [ ] 创建ErpProductionOrderDO.java
- [ ] 创建ErpProductionOrderItemDO.java
- [ ] 创建ErpProductionOrderStatus.java枚举
- [ ] 配置MyBatis映射

#### Day 3: 后端基础框架 - Mapper层
- [ ] 创建ErpProductionOrderMapper.java
- [ ] 创建ErpProductionOrderItemMapper.java
- [ ] 实现基础CRUD操作
- [ ] 创建XML映射文件

**交付物**：
- 基础Mapper接口和XML文件

#### Day 4: 前端基础框架
- [ ] 创建生产单管理路由配置
- [ ] 创建基础页面结构
- [ ] 实现API接口定义
- [ ] 配置菜单权限

### 第二阶段：核心功能开发 (6-8天)

#### Day 5-6: 生产单基础CRUD
- [ ] 实现生产单创建功能
- [ ] 实现生产单查询功能
- [ ] 实现生产单更新功能
- [ ] 创建生产单表单页面
- [ ] 实现基础字段录入

#### Day 7: 产品关联功能
- [ ] 实现源材料选择组件
- [ ] 实现成品选择组件
- [ ] 实现产品关联数据保存
- [ ] 实现库存检查逻辑

#### Day 8: 状态管理功能
- [ ] 实现状态变更接口
- [ ] 实现状态验证逻辑
- [ ] 实现库存充足性检查
- [ ] 创建状态选择器组件

#### Day 9: 查询和筛选功能
- [ ] 实现生产单列表查询
- [ ] 实现多条件筛选
- [ ] 实现分页和排序
- [ ] 实现状态筛选
- [ ] 实现时间范围筛选

#### Day 10: 自定义字段功能
- [ ] 设计自定义字段数据结构
- [ ] 实现自定义字段管理
- [ ] 实现自定义字段表单
- [ ] 实现自定义字段存储

#### Day 11-12: 集成开发
- [ ] 采购管理模块集成
  - [ ] 采购订单页面增加生产单关联
  - [ ] 实现生产单状态自动变更
- [ ] 销售管理模块集成
  - [ ] 销售订单页面增加生产单关联
  - [ ] 实现生产单状态自动变更
- [ ] 库存管理模块集成
  - [ ] 出库页面增加生产单关联
  - [ ] 入库页面增加生产单关联
- [ ] 财务管理模块集成
  - [ ] 收款单页面增加生产单关联

### 第三阶段：高级功能和优化 (3-4天)

#### Day 13: 业务逻辑完善
- [ ] 实现自动状态转换逻辑
- [ ] 实现库存预警功能
- [ ] 完善数据验证
- [ ] 实现异常处理机制
- [ ] 添加操作日志记录

#### Day 14: UI/UX优化
- [ ] 统一界面样式风格
- [ ] 优化响应式布局
- [ ] 添加操作提示和反馈
- [ ] 优化用户体验
- [ ] 添加加载状态指示

#### Day 15: 测试和文档
- [ ] 编写单元测试
- [ ] 执行集成测试
- [ ] 进行功能测试
- [ ] 编写用户使用文档
- [ ] 编写API文档

### 第四阶段：部署和上线 (2-3天)

#### Day 16-17: 系统集成测试
- [ ] 执行端到端测试
- [ ] 进行性能测试
- [ ] 执行安全测试
- [ ] 验证数据一致性
- [ ] 修复发现的问题

#### Day 18: 部署准备
- [ ] 准备生产环境配置
- [ ] 编写数据迁移脚本
- [ ] 制定备份策略
- [ ] 配置监控和告警
- [ ] 准备回滚方案

---

## 🔧 技术实现要点

### 1. 关键技术点

#### 事务管理
```java
@Transactional(rollbackFor = Exception.class)
public void changeProductionOrderStatus(Long id, Integer newStatus) {
    // 库存检查
    // 状态变更
    // 日志记录
}
```

#### 并发控制
- 使用乐观锁防止并发修改
- 库存扣减使用分布式锁
- 状态变更原子性保证

#### 数据一致性
- 生产单与库存数据同步
- 与采购、销售模块数据关联
- 定时数据一致性检查

### 2. 业务逻辑重点

#### 库存检查逻辑
```java
public boolean checkMaterialInventory(Long productionOrderId) {
    // 获取生产单需要的源材料
    // 检查当前库存是否充足
    // 返回检查结果
}
```

#### 状态流转逻辑
- 严格按照状态机模式实现
- 每个状态变更都有前置条件检查
- 状态变更后触发相关业务逻辑

#### 关联处理逻辑
- 采购单关联生产单时自动更新状态
- 销售单关联生产单时自动更新状态
- 库存出入库关联生产单时自动更新状态

### 3. 安全考虑

#### 权限控制
- 不同角色的操作权限限制
- 数据访问权限控制
- 操作日志审计

#### 数据验证
- 输入数据合法性��证
- 业务规则验证
- 数据完整性验证

---

## 📈 预期成果

### 1. 功能成果
- ✅ 完整的生产单管理功能
- ✅ 与现有ERP模块的无缝集成
- ✅ 完善的状态管理和流转
- ✅ 实时的库存检查和预警
- ✅ 自定义字段支持
- ✅ 完整的操作审计日志

### 2. 技术成果
- ✅ 可扩展的模块化架构
- ✅ 高性能的数据处理能力
- ✅ 用户友好的界面体验
- ✅ 完善的文档和测试
- ✅ 安全可靠的数据处理

### 3. 业务价值
- ✅ 提升生产管理效率
- ✅ 实现生产全流程跟踪
- ✅ 降低库存管理成本
- ✅ 提高数据准确性
- ✅ 支持业务决策分析

---

## 🎯 下一步行动计划

### 立即执行 (今天)
1. **创建开发分支**：
   ```bash
   git checkout -b feature/production-order-management
   ```

2. **创建数据库脚本**：
   - 创建 `sql/mysql/production-order-tables.sql`
   - 包含所有必需的表结构和索引

3. **搭建基础后端结构**：
   - 创建生产单相关的包结构
   - 实现基础的DO对象

### 本周内完成
1. **完成数据库设计**
2. **实现基础CRUD功能**
3. **创建前端页面框架**

### 下周计划
1. **实现核心业务逻辑**
2. **完成UI界面开发**
3. **开始模块集成工作**

---

## 📝 注意事项

### 开发规范
- 遵循项目现有的代码规范
- 新增代码需要包含必要的注释
- 提交前进行代码自测
- 及时更新相关文档

### 风险控制
- 定期备份开发数据
- 重要功能变更前进行充分测试
- 保持与现有模块的兼容性
- 注意性能影响评估

### 沟通协调
- 定期同步开发进度
- 及时反馈问题和风险
- 与相关模块负责人协调接口
- 确保业务需求理解一致

---

## 📞 联系方式

如有疑问或需要协调，请联系项目组。

**文档版本**: 1.0
**创建日期**: 2025-11-12
**最后更新**: 2025-11-12
**负责人**: 开发团队