# 采购管理表字段修复说明

## 📋 问题描述

采购管理相关的页面（采购订单、采购入库、采购退货）都提示"服务器错误，请联系管理员"，原因是数据库表缺少必要的字段。

## 🔍 问题分析

通过对比Java实体类（DO）和数据库表结构，发现以下表缺少字段：

### 1. `erp_purchase_in` 表（采购入库）缺失字段：
- `status` - 入库状态
- `order_no` - 采购订单号（冗余字段）
- `total_price` - 最终合计价格
- `payment_price` - 已支付金额
- `discount_price` - 优惠金额

### 2. `erp_purchase_return` 表（采购退货）缺失字段：
- `status` - 退货状态
- `order_no` - 采购订单号（冗余字段）
- `total_price` - 最终合计价格
- `refund_price` - 已退款金额
- `discount_price` - 优惠金额

## 🚀 修复步骤

### 方式1：使用MySQL命令行执行（推荐）

```bash
# 进入脚本目录
cd /Users/xierui/Documents/Project/erp-system/sql/mysql

# 执行修复脚本（请根据实际情况修改数据库连接信息）
mysql -h127.0.0.1 -P3306 -uroot -p123456 ruoyi-vue-pro < erp_purchase_add_fields_migration.sql
```

### 方式2：在MySQL客户端中执行

1. 连接到MySQL数据库：
```bash
mysql -h127.0.0.1 -P3306 -uroot -p123456 ruoyi-vue-pro
```

2. 执行脚本：
```sql
source /Users/xierui/Documents/Project/erp-system/sql/mysql/erp_purchase_add_fields_migration.sql;
```

### 方式3：使用数据库管理工具

使用Navicat、DBeaver、phpMyAdmin等工具，打开 `erp_purchase_add_fields_migration.sql` 文件并执行。

## ⚠️ 注意事项

1. **备份数据库**：执行脚本前，请先备份数据库
   ```bash
   mysqldump -h127.0.0.1 -P3306 -uroot -p123456 ruoyi-vue-pro > backup_purchase_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **数据库连接信息**：
   - 请根据实际情况修改数据库连接参数（主机、端口、用户名、密码、数据库名）

3. **脚本安全性**：
   - 脚本使用 `ALTER TABLE ... ADD COLUMN` 语句
   - 如果字段已存在，会报错，但不影响其他字段的添加
   - 建议先检查字段是否存在

## 🔍 验证方法

执行完成后，可以通过以下SQL验证字段是否添加成功：

```sql
-- 检查采购入库表的字段
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'ruoyi-vue-pro' 
  AND TABLE_NAME = 'erp_purchase_in' 
  AND COLUMN_NAME IN ('status', 'order_no', 'total_price', 'payment_price', 'discount_price');

-- 检查采购退货表的字段
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'ruoyi-vue-pro' 
  AND TABLE_NAME = 'erp_purchase_return' 
  AND COLUMN_NAME IN ('status', 'order_no', 'total_price', 'refund_price', 'discount_price');
```

## 📊 预期结果

执行成功后，应该看到：

1. ✅ `erp_purchase_in` 表新增5个字段：
   - `status` - 入库状态（int类型）
   - `order_no` - 采购订单号（varchar(50)类型）
   - `total_price` - 最终合计价格（decimal(20,2)类型）
   - `payment_price` - 已支付金额（decimal(20,2)类型）
   - `discount_price` - 优惠金额（decimal(20,2)类型）

2. ✅ `erp_purchase_return` 表新增5个字段：
   - `status` - 退货状态（int类型）
   - `order_no` - 采购订单号（varchar(50)类型）
   - `total_price` - 最终合计价格（decimal(20,2)类型）
   - `refund_price` - 已退款金额（decimal(20,2)类型）
   - `discount_price` - 优惠金额（decimal(20,2)类型）

## 🆘 常见问题

### Q1: 执行脚本时提示"Duplicate column name"
**A:** 说明该字段已经存在，可以忽略此错误，继续执行其他字段的添加。

### Q2: 执行脚本后仍然报错
**A:** 
1. 检查是否所有字段都已成功添加
2. 重启应用服务器
3. 清除应用缓存
4. 检查应用日志获取详细错误信息

### Q3: 如何检查字段是否已存在？
**A:** 使用以下SQL查询：
```sql
-- 检查采购入库表
SHOW COLUMNS FROM erp_purchase_in LIKE 'status';
SHOW COLUMNS FROM erp_purchase_in LIKE 'order_no';
-- ... 其他字段

-- 检查采购退货表
SHOW COLUMNS FROM erp_purchase_return LIKE 'status';
SHOW COLUMNS FROM erp_purchase_return LIKE 'order_no';
-- ... 其他字段
```

## 📝 相关文件

- 修复脚本：`sql/mysql/erp_purchase_add_fields_migration.sql`
- 主表结构文件：`sql/mysql/erp-tables.sql`（已更新，包含所有字段）

---

*最后更新时间：2024年*

