# ERP 采购入库问题解决方案

## 问题描述
在采购入库模块中选择采购订单时，搜索不��已经生成的采购订单。

## 问题原因
1. **数据库中没有数据**：系统是全新部署，`erp_purchase_order` 表中没有任何采购订单数据
2. **搜索条件严格**：采购入库功能只会显示状态为"已审核"且还有未入库数量的采购订单

## 解决方案

### 1. 导入示例数据

我们创建了示例数据文件 `sql/mysql/sample-data.sql`，包含以下内容：

- **2个供应商**：供应商A、供应商B
- **5个产品**：笔记本电脑、无线鼠标、机械键盘、显示器、USB数据线
- **3个采购订单**：
  - `CG20241111001`：全部未入库，可以入库10件商品
  - `CG20241111002`：部分已入库（已入库5件），还可以入库5件商品
  - `CG20241111003`：全部未入库，可以入库20件商品

### 2. 导入数据步骤

1. **启动数据库**
   ```bash
   # 确保MySQL数据库正在运行
   ```

2. **创建数据库和表结构**
   ```bash
   # 先执行ERP表结构创建
   mysql -u root -p your_database < sql/mysql/erp-tables.sql
   ```

3. **导入示例数据**
   ```bash
   # 导入示例数据
   mysql -u root -p your_database < sql/mysql/sample-data.sql
   ```

### 3. 验证功能

1. **启动后端应用**
   ```bash
   cd yudao-server
   mvn spring-boot:run
   ```

2. **启动前端应用**
   ```bash
   cd original-yudao-ui
   pnpm dev
   ```

3. **测试采购入库功能**
   - 登录系统（用户名：admin，密码：admin123）
   - 进入 `ERP管理` → `采购管理` → `采购入库`
   - 点击"新增"按钮
   - 在采购订单字段点击"选择"按钮
   - 应该能看到3个可选择的采购订单

### 4. 搜索功能说明

采购入库的采购订单搜索功能支持：

- **订单号模糊搜索**：可输入部分订单号进行搜索
- **产品筛选**：可根据产品ID筛选包含特定产品的订单
- **下单时间范围**：可设置时间范围筛选订单
- **只显示可入库订单**：只显示状态为"已审核"且还有未入库数量的订单

### 5. 手动创建测试数据

如果需要手动创建采购订单进行测试，请按以下步骤：

1. **创建供应商**：ERP管理 → 基础信息 → 供应商
2. **创建产品**：ERP管理 → 基础信息 → 产品
3. **创建采购订单**：ERP管理 → 采购管理 → 采购订单
4. **审核订单**：将采购订单状态改为"已审核"
5. **测试入库**：在采购入库中选择该订单

### 6. 技术说明

**搜索逻辑**（参考 `ErpPurchaseOrderMapper.java:48-52`）：
```java
if (Boolean.TRUE.equals(reqVO.getInEnable())) {
    query.eq(ErpPurchaseOrderDO::getStatus, ErpAuditStatus.APPROVE.getStatus()) // 状态必须是20（已审核）
            .apply("t.in_count < t.total_count"); // 入库数量必须小于总数量
}
```

**状态枚举**（参考 `ErpAuditStatus.java`）：
- `PROCESS (10)`：未审核
- `APPROVE (20)`：已审核

只有满足以下条件的采购订单才会在采购入库选择界面显示：
1. 订单状态为"已审核"（status = 20）
2. 已入库数量 < 总数量（in_count < total_count）
3. 订单未被删除（deleted = false）

### 7. 故障排查

如果导入数据后仍然搜索不到采购订单，请检查：

1. **数据库连接**：确认应用配置的数据库连接正确
2. **数据导入**：检查SQL是否成功执行，数据是否存在于对应表中
3. **订单状态**：确认采购订单的status字段为20（已审核）
4. **入库数量**：确认in_count小于total_count
5. **日志查看**：查看应用日志中是否有SQL查询错误

---

## 联系方式

如有问题，请查看系统日志或联系开发团队。