# 部署问题排查 - Docker镜像拉取失败

## 🔍 问题描述

虽然安全组规则已正确配置（入向和出向都允许），但无法从Docker Hub拉取镜像，出现连接超时错误。

## ✅ 已确认的配置

1. **安全组入向规则** ✓
   - SSH (22端口) - 允许
   - HTTP (80端口) - 允许
   - HTTPS (443端口) - 允许
   - ICMP (ping) - 允许

2. **安全组出向规则** ✓
   - 策略: 允许
   - 协议类型: ALL
   - 端口范围: ALL
   - 目的地址: 0.0.0.0/0
   - 描述: 放通全部流量

3. **系统环境** ✓
   - Docker 29.1.1 已安装
   - Docker Compose v2.40.3 已安装
   - 项目代码已上传
   - 环境变量已配置

## ⚠️ 当前问题

```
Error: failed to resolve reference "docker.io/library/mysql:8": 
failed to do request: Head "https://registry-1.docker.io/v2/library/mysql/manifests/8": 
dial tcp 154.83.15.45:443: connect: connection timed out
```

## 🔧 排查步骤

### 1. 检查DNS解析

```bash
# 在服务器上执行
getent hosts registry-1.docker.io
nslookup registry-1.docker.io
```

**结果**: DNS解析正常 ✓

### 2. 检查网络连接

```bash
# 测试HTTPS连接
curl -I https://registry-1.docker.io
ping -c 3 8.8.8.8
```

**结果**: 
- 可以ping通外网 ✓
- 可以访问百度 ✓
- 无法连接Docker Hub ✗

### 3. 尝试镜像加速器

已尝试多个国内镜像源，均返回403错误或连接失败。

## 💡 解决方案

### 方案1: 联系火山引擎技术支持（推荐）

1. 登录火山引擎控制台
2. 提交工单，说明问题：
   - 安全组规则已正确配置
   - 可以访问其他网站（如百度）
   - 但无法连接Docker Hub (registry-1.docker.io:443)
   - 请求检查网络路由配置

### 方案2: 使用火山引擎容器镜像服务

如果火山引擎提供容器镜像服务（类似阿里云ACR），可以：

1. 在火山引擎控制台创建镜像仓库
2. 将Docker镜像推送到火山引擎镜像仓库
3. 在服务器上从火山引擎镜像仓库拉取

### 方案3: 使用代理服务器

如果有可用的代理服务器：

```bash
# 配置Docker使用代理
mkdir -p /etc/systemd/system/docker.service.d
cat > /etc/systemd/system/docker.service.d/http-proxy.conf << EOF
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080"
Environment="HTTPS_PROXY=http://proxy.example.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1"
EOF

systemctl daemon-reload
systemctl restart docker
```

### 方案4: 手动导入镜像（临时方案）

如果本地或其他环境可以访问Docker Hub：

```bash
# 1. 在可访问Docker Hub的环境拉取镜像
docker pull mysql:8
docker pull redis:6-alpine

# 2. 导出镜像
docker save mysql:8 redis:6-alpine | gzip > images.tar.gz

# 3. 上传到服务器
scp -i your-key.pem images.tar.gz root@your-server:/tmp/

# 4. 在服务器上导入
ssh your-server
gunzip -c /tmp/images.tar.gz | docker load
```

### 方案5: 等待网络恢复

有时是临时网络问题，可以稍后重试：

```bash
cd /opt/erp-system/script/docker
docker compose -f docker-compose.prod.yml --env-file .env pull
```

## 📝 下一步行动

1. **立即行动**: 联系火山引擎技术支持，说明网络连接问题
2. **临时方案**: 如果急需部署，考虑使用方案4（手动导入镜像）
3. **长期方案**: 配置火山引擎容器镜像服务（如果可用）

## 🔗 相关文档

- [安全组出向规则配置](./安全组出向规则配置.md)
- [火山引擎部署指南](./火山引擎部署指南.md)

---

**注意**: 安全组规则配置是正确的，问题在于网络路由层面，需要云服务商协助排查。

