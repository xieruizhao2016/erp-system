# 宝塔面板无法访问 - 排查指南

## 🔍 问题现象

- 宝塔面板地址无法访问
- SSH连接也失败（Connection timeout）

## ⚠️ 可能的原因

1. **服务器重启** - 最常见原因
2. **安全组规则被修改** - 端口未开放
3. **防火墙规则变化** - 端口被阻止
4. **网络问题** - 服务器网络异常
5. **宝塔服务停止** - 服务未启动

## 🔧 排查步骤

### 步骤1: 检查服务器状态（火山引擎控制台）

1. 登录火山引擎控制台
2. 进入 **云服务器 ECS** → **实例列表**
3. 找到你的服务器（115.190.240.137）
4. 检查 **运行状态**：
   - ✅ **运行中** - 服务器正常
   - ⚠️ **已停止** - 需要启动服务器
   - ❌ **异常** - 需要联系技术支持

### 步骤2: 检查安全组规则

1. 在服务器详情页，点击 **安全组**
2. 进入安全组规则配置
3. 检查 **入向规则** 是否包含：
   ```
   端口: 23448
   协议: TCP
   源地址: 0.0.0.0/0
   动作: 允许
   ```
4. 如果没有，**添加规则**

### 步骤3: 检查SSH端口（22端口）

1. 在安全组中检查 **22端口** 是否开放
2. 如果没有，添加规则：
   ```
   端口: 22
   协议: TCP
   源地址: 0.0.0.0/0
   动作: 允许
   ```

### 步骤4: 使用VNC控制台（如果SSH无法连接）

1. 在服务器详情页，点击 **远程连接** → **VNC控制台**
2. 输入root密码：`Xie12580...`
3. 登录后执行以下命令：

```bash
# 检查宝塔服务状态
/etc/init.d/bt status

# 检查端口监听
netstat -tlnp | grep 23448

# 检查防火墙
firewall-cmd --list-ports | grep 23448

# 如果端口未开放，开放端口
firewall-cmd --permanent --add-port=23448/tcp
firewall-cmd --reload

# 重启宝塔服务
/etc/init.d/bt restart

# 查看宝塔登录信息
/etc/init.d/bt default
```

### 步骤5: 重启宝塔服务

如果服务器正常运行，但宝塔无法访问：

```bash
# 重启宝塔服务
/etc/init.d/bt restart

# 或者
systemctl restart btpanel

# 检查服务状态
systemctl status btpanel
```

### 步骤6: 检查防火墙

```bash
# 查看防火墙状态
systemctl status firewalld

# 如果防火墙开启，开放端口
firewall-cmd --permanent --add-port=23448/tcp
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --reload

# 验证端口
firewall-cmd --list-ports
```

## 🚨 紧急处理方案

### 如果服务器已停止

1. 在火山引擎控制台启动服务器
2. 等待1-2分钟让服务器完全启动
3. 重新尝试访问宝塔面板

### 如果安全组规则丢失

1. 重新添加安全组规则：
   - **22端口** (SSH)
   - **23448端口** (宝塔面板)
   - **80端口** (HTTP，前端访问)
   - **48080端口** (后端API)
   - **3306端口** (MySQL，如需要)
   - **6379端口** (Redis，如需要)

### 如果宝塔服务异常

```bash
# 重新安装宝塔（会保留数据）
curl -sSO https://download.bt.cn/install/install_panel.sh && bash install_panel.sh

# 或者修复宝塔
/etc/init.d/bt repair
```

## 📋 需要检查的端口清单

确保以下端口在安全组中已开放：

| 端口 | 服务 | 说明 |
|------|------|------|
| 22 | SSH | 远程连接 |
| 23448 | 宝塔面板 | 管理面板 |
| 80 | HTTP | 前端访问 |
| 48080 | 后端API | 后端服务 |
| 3306 | MySQL | 数据库（可选） |
| 6379 | Redis | 缓存（可选） |

## 🔄 恢复后的操作

### 1. 检查Docker服务

```bash
# 检查Docker状态
systemctl status docker

# 如果Docker未运行，启动
systemctl start docker

# 检查容器状态
cd /opt/erp-system/script/docker
docker compose -f docker-compose.prod.yml ps
```

### 2. 重启ERP服务（如果需要）

```bash
cd /opt/erp-system/script/docker

# 启动所有服务
docker compose -f docker-compose.prod.yml --env-file .env up -d

# 检查服务状态
docker compose -f docker-compose.prod.yml ps
```

### 3. 检查宝塔面板

```bash
# 获取登录信息
/etc/init.d/bt default

# 访问地址
# https://115.190.240.137:23448/xxxxx
```

## 💡 预防措施

1. **定期备份** - 使用宝塔面板的备份功能
2. **监控服务** - 设置服务监控告警
3. **安全组规则** - 记录安全组配置，避免误删
4. **文档记录** - 保存重要配置信息

## 🆘 如果以上都无效

1. **联系火山引擎技术支持**
   - 说明服务器无法SSH连接
   - 提供服务器IP：115.190.240.137
   - 请求检查服务器状态和网络

2. **检查服务器资源**
   - CPU使用率
   - 内存使用率
   - 磁盘空间

---

**重要提示**: 如果SSH无法连接，优先使用火山引擎控制台的VNC功能进行排查。

