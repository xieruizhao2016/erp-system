# 火山引擎安全组 - 出向规则配置指南

## 🔍 问题诊断

当前无法从 Docker Hub 拉取镜像，原因是**出向规则**可能限制了对外部网络的访问。

## ✅ 解决方案

### 步骤1: 检查出向规则

1. 登录火山引擎控制台
2. 进入 **云服务器 ECS** > **安全组**
3. 找到你的安全组（Default）
4. 点击 **访问规则** 标签
5. 切换到 **出向规则** 标签

### 步骤2: 添加出向规则

如果出向规则为空或有限制，需要添加以下规则：

#### 规则1: 允许所有出向流量（推荐用于测试）

```
策略: 允许
协议类型: ALL
端口范围: ALL
目标地址: 0.0.0.0/0
描述: 允许所有出向流量
优先级: 100
```

#### 规则2: 仅允许HTTPS出向（更安全）

```
策略: 允许
协议类型: TCP
端口范围: 443
目标地址: 0.0.0.0/0
描述: 允许HTTPS出向连接（用于Docker镜像拉取）
优先级: 100
```

#### 规则3: 允许HTTP出向（可选）

```
策略: 允许
协议类型: TCP
端口范围: 80
目标地址: 0.0.0.0/0
描述: 允许HTTP出向连接
优先级: 100
```

#### 规则4: 允许DNS查询（重要）

```
策略: 允许
协议类型: UDP
端口范围: 53
目标地址: 0.0.0.0/0
描述: 允许DNS查询
优先级: 100
```

### 步骤3: 验证配置

配置完成后，在服务器上测试：

```bash
# 测试DNS解析
nslookup registry-1.docker.io

# 测试HTTPS连接
curl -I https://registry-1.docker.io

# 测试Docker拉取
docker pull hello-world
```

## 🔄 替代方案：使用国内镜像源

如果无法访问 Docker Hub，可以配置国内镜像源：

### 配置阿里云镜像加速器

1. 登录阿里云容器镜像服务：https://cr.console.aliyun.com/
2. 获取专属加速地址（每个账号不同）
3. 在服务器上配置：

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://你的专属地址.mirror.aliyuncs.com"
  ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 配置其他镜像源

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

## 📝 当前入向规则检查清单

根据截图，你的入向规则已正确配置：

- ✅ SSH (22端口) - 已配置
- ✅ HTTP (80端口) - 已配置  
- ✅ HTTPS (443端口) - 已配置
- ✅ ICMP (ping) - 已配置
- ⚠️ **需要检查：出向规则**

## ⚠️ 重要提示

1. **出向规则默认策略**：
   - 如果出向规则为空，通常默认允许所有出向流量
   - 如果出向规则存在"拒绝"规则，需要添加"允许"规则

2. **安全建议**：
   - 生产环境建议限制出向规则，只允许必要的端口
   - 测试环境可以暂时允许所有出向流量

3. **优先级**：
   - 数字越小，优先级越高
   - 建议将允许规则设置为较高优先级（小数字）

---

**配置完成后，重新尝试部署：**

```bash
cd /opt/erp-system/script/docker
docker compose -f docker-compose.prod.yml --env-file .env up -d --build
```

