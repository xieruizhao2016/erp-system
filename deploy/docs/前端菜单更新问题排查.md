# 前端菜单更新问题排查指南

## 📋 问题描述

前端菜单没有显示最新的功能，即使已经更新了前端代码。

## 🔍 问题原因分析

### 菜单数据来源

前端菜单**不是写死在前端代码中**，而是从后端API动态获取的：

1. **登录时获取菜单数据**
   - API: `/admin-api/system/auth/get-permission-info`
   - 返回用户信息、权限、角色和菜单列表

2. **菜单数据存储**
   - 存储在浏览器缓存中（使用 `wsCache`）
   - 缓存键: `ROLE_ROUTERS`
   - 位置: `original-yudao-ui/src/store/modules/user.ts`

3. **菜单路由生成**
   - 登录后调用 `permissionStore.generateRoutes()`
   - 从缓存中读取菜单数据生成路由
   - 位置: `original-yudao-ui/src/store/modules/permission.ts`

### 可能的原因

1. **浏览器缓存了旧的菜单数据**（最常见）
   - 浏览器缓存了之前的菜单数据
   - 即使前端代码更新了，缓存数据还是旧的

2. **后端菜单数据没有更新**
   - 数据库中菜单数据没有更新
   - 新菜单没有添加到数据库

3. **用户权限问题**
   - 当前用户角色没有新菜单的权限
   - 菜单的"可见"状态设置为"隐藏"

4. **前端代码没有正确更新**
   - 前端文件没有正确上传到服务器
   - 容器内文件没有更新

## ✅ 解决方案

### 方案1: 清除浏览器缓存（推荐，先尝试）

**方法A: 使用浏览器清除缓存功能**
1. 按 `Ctrl+Shift+Delete` (Windows) 或 `Cmd+Shift+Delete` (Mac)
2. 选择"缓存的图片和文件"
3. 时间范围选择"全部时间"
4. 点击"清除数据"
5. 刷新页面或重新登录

**方法B: 使用开发者工具**
1. 按 `F12` 打开开发者工具
2. 切换到 `Application` 标签（Chrome）或 `存储` 标签（Firefox）
3. 左侧找到 `Local Storage` 或 `Session Storage`
4. 找到网站域名，右键选择"清除"
5. 刷新页面

**方法C: 使用无痕模式**
1. 按 `Ctrl+Shift+N` (Chrome) 或 `Ctrl+Shift+P` (Firefox)
2. 访问: http://101.33.244.240
3. 登录测试菜单是否正常

### 方案2: 重新登录

1. 退出当前登录
2. 清除浏览器缓存（参考方案1）
3. 重新登录
   - 登录时会重新调用 `/admin-api/system/auth/get-permission-info`
   - 获取最新的菜单数据

### 方案3: 检查后端菜单数据

1. **登录后台管理系统**
   - 访问: http://101.33.244.240
   - 使用管理员账号登录

2. **检查菜单管理**
   - 进入: `系统管理` -> `菜单管理`
   - 检查是否有新菜单项
   - 检查菜单的"可见"状态是否为"显示"
   - 检查菜单的"状态"是否为"启用"

3. **检查菜单配置**
   - 菜单路径是否正确
   - 菜单组件路径是否正确
   - 菜单图标是否配置

### 方案4: 检查用户权限

1. **检查角色权限**
   - 进入: `系统管理` -> `角色管理`
   - 找到当前用户所属的角色
   - 检查角色是否有新菜单的权限
   - 如果没有，需要分配权限

2. **检查用户角色**
   - 进入: `系统管理` -> `用户管理`
   - 找到当前用户
   - 检查用户所属的角色
   - 确认角色有正确的菜单权限

### 方案5: 强制刷新前端文件

如果前端代码有更新，需要重新部署：

```bash
# 在本地执行
cd /Users/xierui/Documents/Project/Other/erp-system

# 重新构建并部署
./scripts/deploy-prod.sh
```

或者手动更新前端：

```bash
# 1. 构建前端
cd original-yudao-ui
pnpm build:prod

# 2. 上传到服务器
cd ..
scp -i tengxunyun.pem -r original-yudao-ui/dist-prod/* \
  ubuntu@101.33.244.240:/tmp/dist-prod/

# 3. 更新容器
ssh -i tengxunyun.pem ubuntu@101.33.244.240 \
  "docker cp /tmp/dist-prod/. yudao-admin-prod:/usr/share/nginx/html/"
```

## 🔧 验证步骤

### 1. 检查前端文件是否更新

```bash
ssh -i tengxunyun.pem ubuntu@101.33.244.240 \
  "docker exec yudao-admin-prod ls -lth /usr/share/nginx/html/index.html"
```

### 2. 检查后端服务状态

```bash
ssh -i tengxunyun.pem ubuntu@101.33.244.240 \
  "docker ps | grep yudao-server"
```

### 3. 测试菜单API（需要登录token）

```bash
# 登录后获取token，然后测试
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://101.33.244.240:48080/admin-api/system/auth/get-permission-info
```

## 📝 常见问题

### Q1: 为什么更新了前端代码，菜单还是没有变化？

**A:** 因为菜单数据是从后端API获取的，存储在浏览器缓存中。即使前端代码更新了，如果浏览器缓存没有清除，菜单数据还是旧的。

### Q2: 如何确认是缓存问题还是后端问题？

**A:** 
1. 使用无痕模式访问，如果菜单正常，说明是缓存问题
2. 如果无痕模式也不正常，检查后端菜单数据和用户权限

### Q3: 菜单数据在哪里存储？

**A:** 
- 后端：存储在数据库的 `system_menu` 表中
- 前端：存储在浏览器的 LocalStorage 中（键名: `ROLE_ROUTERS`）

### Q4: 如何查看当前缓存的菜单数据？

**A:** 
1. 按 `F12` 打开开发者工具
2. 切换到 `Application` 标签
3. 左侧找到 `Local Storage` -> 网站域名
4. 查找 `ROLE_ROUTERS` 键，查看其值

## 🎯 快速排查流程

```
1. 使用无痕模式访问 → 菜单正常？
   ├─ 是 → 清除浏览器缓存 ✅
   └─ 否 → 继续

2. 检查后端菜单数据 → 菜单存在？
   ├─ 是 → 检查用户权限
   └─ 否 → 添加菜单到数据库

3. 检查用户权限 → 有权限？
   ├─ 是 → 重新登录
   └─ 否 → 分配权限

4. 重新登录 → 菜单正常？
   ├─ 是 → 问题解决 ✅
   └─ 否 → 检查前端代码更新
```

---

**最后更新：** 2025-12-21  
**适用服务器：** 腾讯云 (101.33.244.240)

