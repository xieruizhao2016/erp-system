# æœ¬åœ°æ„å»ºDockeré•œåƒéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°æ„å»ºDockeré•œåƒï¼Œç„¶åä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²ã€‚è¿™ç§æ–¹å¼ç›¸æ¯”åœ¨äº‘æœåŠ¡å™¨ä¸Šæ„å»ºæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **ä¼˜åŠ¿ï¼š**
- åˆ©ç”¨æœ¬åœ°æ›´å¥½çš„ç¡¬ä»¶é…ç½®ï¼Œæ„å»ºé€Ÿåº¦æ›´å¿«
- å‡å°‘äº‘æœåŠ¡å™¨èµ„æºæ¶ˆè€—
- é¿å…äº‘æœåŠ¡å™¨ç½‘ç»œé—®é¢˜å¯¼è‡´çš„æ„å»ºå¤±è´¥
- å¯ä»¥æå‰éªŒè¯é•œåƒæ„å»ºæ˜¯å¦æˆåŠŸ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1ï¼šä¸€é”®æ„å»ºå’Œä¸Šä¼ ï¼ˆæ¨èï¼‰

```bash
# 1. åœ¨æœ¬åœ°æ„å»ºé•œåƒ
cd /path/to/erp-system
./deploy/scripts/build-images-local.sh

# 2. å¯¼å‡ºé•œåƒ
./deploy/scripts/export-app-images.sh

# 3. ä¸Šä¼ å¹¶å¯¼å…¥åˆ°æœåŠ¡å™¨
./deploy/scripts/upload-app-images.sh
```

### æ–¹æ³•2ï¼šåˆ†æ­¥æ‰§è¡Œ

#### æ­¥éª¤1ï¼šæœ¬åœ°æ„å»ºé•œåƒ

```bash
cd /path/to/erp-system
./deploy/scripts/build-images-local.sh
```

**æ­¤è„šæœ¬ä¼šï¼š**
- æ£€æŸ¥å¹¶æ„å»ºåç«¯JARæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- æ„å»º `yudao-server:latest` é•œåƒ
- æ„å»º `yudao-admin:latest` é•œåƒ

**é¢„è®¡æ—¶é—´ï¼š**
- åç«¯æ„å»ºï¼š2-5åˆ†é’Ÿï¼ˆå–å†³äºMavenä¾èµ–ä¸‹è½½ï¼‰
- å‰ç«¯æ„å»ºï¼š3-10åˆ†é’Ÿï¼ˆå–å†³äºnpmä¾èµ–ä¸‹è½½ï¼‰
- æ€»æ—¶é—´ï¼š5-15åˆ†é’Ÿ

#### æ­¥éª¤2ï¼šå¯¼å‡ºé•œåƒ

```bash
./deploy/scripts/export-app-images.sh
```

**æ­¤è„šæœ¬ä¼šï¼š**
- æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
- å¯¼å‡ºé•œåƒåˆ° `deploy/exports/app-images-YYYYMMDD-HHMMSS.tar.gz`
- æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œä¸‹ä¸€æ­¥æ“ä½œ

**æ–‡ä»¶ä½ç½®ï¼š** `deploy/exports/app-images-*.tar.gz`

#### æ­¥éª¤3ï¼šä¸Šä¼ å¹¶å¯¼å…¥åˆ°æœåŠ¡å™¨

```bash
# è‡ªåŠ¨ä¸Šä¼ æœ€æ–°å¯¼å‡ºçš„é•œåƒ
./deploy/scripts/upload-app-images.sh

# æˆ–æŒ‡å®šé•œåƒæ–‡ä»¶
./deploy/scripts/upload-app-images.sh deploy/exports/app-images-20240101-120000.tar.gz

# æˆ–æŒ‡å®šæœåŠ¡å™¨åœ°å€
./deploy/scripts/upload-app-images.sh deploy/exports/app-images-20240101-120000.tar.gz root@your-server-ip
```

**æ­¤è„šæœ¬ä¼šï¼š**
- ä¸Šä¼ é•œåƒæ–‡ä»¶åˆ°æœåŠ¡å™¨çš„ `/tmp/` ç›®å½•
- SSHåˆ°æœåŠ¡å™¨å¹¶å¯¼å…¥é•œåƒ
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- æ˜¾ç¤ºå·²å¯¼å…¥çš„é•œåƒ

#### æ­¥éª¤4ï¼šåœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨æœåŠ¡

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh -i ~/Documents/huoshan-ssh.pem root@115.190.240.137

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/erp-system/script/docker

# å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨å·²å¯¼å…¥çš„é•œåƒï¼Œä¸é‡æ–°æ„å»ºï¼‰
docker-compose -f docker-compose.prod.yml --env-file .env up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

## ğŸ“ è¯¦ç»†è¯´æ˜

### å‰ç½®è¦æ±‚

**æœ¬åœ°ç¯å¢ƒï¼š**
- Docker Desktop æˆ– Docker Engine
- Docker Compose
- Mavenï¼ˆç”¨äºæ„å»ºåç«¯JARï¼‰
- Node.js å’Œ pnpmï¼ˆå¯é€‰ï¼Œå¦‚æœå‰ç«¯éœ€è¦æœ¬åœ°æ„å»ºï¼‰

**æœåŠ¡å™¨ç¯å¢ƒï¼š**
- Docker å·²å®‰è£…
- Docker Compose å·²å®‰è£…
- SSH è®¿é—®æƒé™
- è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘2GBï¼‰

### æ„å»ºå‚æ•°é…ç½®

å¦‚æœéœ€è¦è‡ªå®šä¹‰æ„å»ºå‚æ•°ï¼Œå¯ä»¥åœ¨ `script/docker/.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# å‰ç«¯æ„å»ºå‚æ•°
NODE_ENV=production
PUBLIC_PATH=/
VUE_APP_TITLE=ERPç®¡ç†ç³»ç»Ÿ
VUE_APP_BASE_API=/prod-api
VUE_APP_APP_NAME=/
VUE_APP_TENANT_ENABLE=true
VUE_APP_CAPTCHA_ENABLE=true
VUE_APP_DOC_ENABLE=true
```

### æ‰‹åŠ¨æ“ä½œæ­¥éª¤

å¦‚æœè„šæœ¬æ— æ³•ä½¿ç”¨ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

#### 1. æœ¬åœ°æ„å»ºé•œåƒ

```bash
cd /path/to/erp-system

# æ„å»ºåç«¯JARï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mvn clean package -DskipTests

# æ„å»ºDockeré•œåƒ
cd script/docker
docker-compose -f docker-compose.prod.yml build
```

#### 2. å¯¼å‡ºé•œåƒ

```bash
# å¯¼å‡ºåº”ç”¨é•œåƒ
docker save yudao-server:latest yudao-admin:latest | gzip > app-images.tar.gz
```

#### 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# ä½¿ç”¨SCPä¸Šä¼ 
scp -i ~/Documents/huoshan-ssh.pem app-images.tar.gz root@115.190.240.137:/tmp/

# æˆ–ä½¿ç”¨å®å¡”é¢æ¿æ–‡ä»¶ç®¡ç†ä¸Šä¼ åˆ° /tmp/ ç›®å½•
```

#### 4. åœ¨æœåŠ¡å™¨ä¸Šå¯¼å…¥

```bash
# SSHåˆ°æœåŠ¡å™¨
ssh -i ~/Documents/huoshan-ssh.pem root@115.190.240.137

# å¯¼å…¥é•œåƒ
gunzip -c /tmp/app-images.tar.gz | docker load

# éªŒè¯å¯¼å…¥
docker images | grep -E "yudao-server|yudao-admin"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/app-images.tar.gz
```

#### 5. å¯åŠ¨æœåŠ¡

```bash
cd /opt/erp-system/script/docker

# å¯åŠ¨æœåŠ¡ï¼ˆä¸é‡æ–°æ„å»ºï¼‰
docker-compose -f docker-compose.prod.yml --env-file .env up -d

# æ£€æŸ¥çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²æµç¨‹

å½“ä»£ç æœ‰æ›´æ–°æ—¶ï¼ŒæŒ‰ä»¥ä¸‹æµç¨‹æ“ä½œï¼š

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 2. æœ¬åœ°æ„å»ºæ–°é•œåƒ
./deploy/scripts/build-images-local.sh

# 3. å¯¼å‡ºé•œåƒ
./deploy/scripts/export-app-images.sh

# 4. ä¸Šä¼ å¹¶å¯¼å…¥åˆ°æœåŠ¡å™¨
./deploy/scripts/upload-app-images.sh

# 5. SSHåˆ°æœåŠ¡å™¨é‡å¯æœåŠ¡
ssh -i ~/Documents/huoshan-ssh.pem root@115.190.240.137
cd /opt/erp-system/script/docker
docker-compose -f docker-compose.prod.yml --env-file .env up -d --force-recreate
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é•œåƒå¤§å°ï¼š**
   - åº”ç”¨é•œåƒé€šå¸¸ä¸º 200-500MBï¼ˆå‹ç¼©åï¼‰
   - ç¡®ä¿æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´

2. **ç½‘ç»œè¦æ±‚ï¼š**
   - æœ¬åœ°éœ€è¦èƒ½è®¿é—®Docker Hubæˆ–é•œåƒæº
   - ä¸Šä¼ é•œåƒéœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥

3. **æ„å»ºç¯å¢ƒï¼š**
   - ç¡®ä¿æœ¬åœ°Dockeræœ‰è¶³å¤Ÿèµ„æºï¼ˆå»ºè®®è‡³å°‘4GBå†…å­˜ï¼‰
   - æ„å»ºè¿‡ç¨‹ä¸­ä¸è¦å…³é—­ç»ˆç«¯

4. **ç‰ˆæœ¬ç®¡ç†ï¼š**
   - å»ºè®®åœ¨å¯¼å‡ºæ–‡ä»¶åä¸­åŒ…å«æ—¶é—´æˆ³
   - ä¿ç•™æ—§ç‰ˆæœ¬é•œåƒä½œä¸ºå¤‡ä»½

5. **æœåŠ¡å™¨é…ç½®ï¼š**
   - ç¡®ä¿æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶é…ç½®æ­£ç¡®
   - é¦–æ¬¡éƒ¨ç½²éœ€è¦å…ˆå¯¼å…¥åŸºç¡€é•œåƒï¼ˆmysqlã€redisç­‰ï¼‰

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: æ„å»ºå¤±è´¥ï¼Œæç¤ºMavenæœªå®‰è£…

**è§£å†³ï¼š**
```bash
# macOS
brew install maven

# Linux
sudo apt-get install maven
# æˆ–
sudo yum install maven
```

### Q2: æ„å»ºå¤±è´¥ï¼Œæç¤ºDockeræœªè¿è¡Œ

**è§£å†³ï¼š**
- macOS: å¯åŠ¨ Docker Desktop
- Linux: `sudo systemctl start docker`

### Q3: ä¸Šä¼ å¤±è´¥ï¼Œæç¤ºSSHè¿æ¥é”™è¯¯

**è§£å†³ï¼š**
1. æ£€æŸ¥SSHå¯†é’¥è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æœåŠ¡å™¨IPå’Œç”¨æˆ·å
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. å°è¯•æ‰‹åŠ¨SSHè¿æ¥æµ‹è¯•

### Q4: å¯¼å…¥å¤±è´¥ï¼Œæç¤ºç©ºé—´ä¸è¶³

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç†ä¸éœ€è¦çš„é•œåƒ
docker image prune -a

# æ¸…ç†ä¸éœ€è¦çš„å®¹å™¨
docker container prune
```

### Q5: æœåŠ¡å¯åŠ¨å¤±è´¥

**è§£å†³ï¼š**
1. æ£€æŸ¥é•œåƒæ˜¯å¦å·²å¯¼å…¥ï¼š`docker images`
2. æ£€æŸ¥ `.env` æ–‡ä»¶é…ç½®æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—ï¼š`docker-compose logs -f`
4. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿéƒ¨ç½²æŒ‡å—](../å¿«é€Ÿéƒ¨ç½².md)
- [å®å¡”é¢æ¿å¯¼å…¥Dockeré•œåƒæŒ‡å—](./å®å¡”é¢æ¿å¯¼å…¥Dockeré•œåƒæŒ‡å—.md)
- [éƒ¨ç½²æ£€æŸ¥æ¸…å•](./éƒ¨ç½²æ£€æŸ¥æ¸…å•.md)

---

**æç¤ºï¼š** æœ¬åœ°æ„å»ºæ–¹å¼ç‰¹åˆ«é€‚åˆé¢‘ç¹æ›´æ–°çš„å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥å¤§å¤§èŠ‚çœéƒ¨ç½²æ—¶é—´ï¼

