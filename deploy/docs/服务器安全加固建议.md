# 服务器安全加固建议

**扫描时间：** 2025-12-05 23:47:02  
**安全评分：** 18分（满分100分）  
**检测到的风险：** 48个

## 🔴 高危风险（必须修复）

### 1. 检查是否存在空密码用户
**风险等级：** 🔴 高危  
**影响：** 如果存在空密码用户，攻击者可以直接登录系统，造成严重安全威胁。

**修复方法：**
```bash
# 检查空密码用户
sudo awk -F: '($2 == "") {print $1}' /etc/shadow

# 如果发现空密码用户，需要设置密码
sudo passwd <用户名>

# 或者禁用该用户
sudo usermod -L <用户名>
```

**建议：** 立即修复，这是最高优先级的安全问题。

## 🟠 中危风险（建议修复）

### 2. 检查是否拒绝IPv6源路由数据包
**风险等级：** 🟠 中危  
**影响：** 源路由可能被用于网络攻击。

**修复方法：**
```bash
# 编辑 sysctl 配置
sudo nano /etc/sysctl.conf

# 添加以下配置
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# 应用配置
sudo sysctl -p
```

### 3. 检查nosuid是否禁止/tmp中创建
**风险等级：** 🟠 中危  
**影响：** /tmp 目录如果允许执行 setuid 程序，可能被利用提升权限。

**修复方法：**
```bash
# 检查当前挂载选项
mount | grep /tmp

# 编辑 /etc/fstab，确保 /tmp 有 nosuid 选项
sudo nano /etc/fstab

# 重新挂载（如果已挂载）
sudo mount -o remount,nosuid /tmp
```

### 4. 检查是否禁用DCCP内核模块
**风险等级：** 🟠 中危  
**影响：** DCCP 协议如果不需要，应该禁用以减少攻击面。

**修复方法：**
```bash
# 禁用 DCCP 模块
echo "install dccp /bin/true" | sudo tee -a /etc/modprobe.d/blacklist.conf
echo "blacklist dccp" | sudo tee -a /etc/modprobe.d/blacklist.conf
```

### 5. 是否限制核心转储
**风险等级：** 🟠 中危  
**影响：** 核心转储可能泄露敏感信息。

**修复方法：**
```bash
# 编辑 /etc/security/limits.conf
sudo nano /etc/security/limits.conf

# 添加以下行
* soft core 0
* hard core 0

# 或者通过 sysctl
echo "fs.suid_dumpable = 0" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 6. 检查是否禁用IPv6路由器通告
**风险等级：** 🟠 中危  
**影响：** IPv6 路由器通告可能被用于中间人攻击。

**修复方法：**
```bash
# 编辑 sysctl 配置
sudo nano /etc/sysctl.conf

# 添加以下配置
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# 应用配置
sudo sysctl -p
```

## 📋 修复优先级建议

### 立即修复（生产环境必需）
1. ✅ **空密码用户检查** - 高危，必须立即修复
2. ✅ **核心转储限制** - 防止信息泄露
3. ✅ **nosuid 设置** - 防止权限提升

### 建议修复（提高安全性）
4. ⚠️ **IPv6 相关配置** - 如果使用 IPv6，需要谨慎配置
5. ⚠️ **DCCP 模块禁用** - 如果不需要该协议

### 可选修复（根据需求）
6. ℹ️ 其他中低危风险 - 根据实际业务需求决定

## 🛠️ 批量修复建议

### 方式一：通过宝塔面板修复
1. 登录宝塔面板
2. 进入"安全" → "安全风险"
3. 勾选需要修复的项目
4. 点击"修复选中项"（如果支持自动修复）
5. 对于无法自动修复的项目，按照上述手动方法修复

### 方式二：手动修复脚本
可以创建一个安全加固脚本，批量应用这些配置：

```bash
#!/bin/bash
# 服务器安全加固脚本

# 1. 禁用 IPv6 源路由
echo "net.ipv6.conf.all.accept_source_route = 0" >> /etc/sysctl.conf
echo "net.ipv6.conf.default.accept_source_route = 0" >> /etc/sysctl.conf

# 2. 禁用 IPv6 路由器通告
echo "net.ipv6.conf.all.accept_ra = 0" >> /etc/sysctl.conf
echo "net.ipv6.conf.default.accept_ra = 0" >> /etc/sysctl.conf

# 3. 限制核心转储
echo "fs.suid_dumpable = 0" >> /etc/sysctl.conf
echo "* soft core 0" >> /etc/security/limits.conf
echo "* hard core 0" >> /etc/security/limits.conf

# 4. 禁用 DCCP 模块
echo "install dccp /bin/true" >> /etc/modprobe.d/blacklist.conf
echo "blacklist dccp" >> /etc/modprobe.d/blacklist.conf

# 应用 sysctl 配置
sysctl -p

echo "安全加固配置已应用，请重启服务器使部分配置生效"
```

## ⚠️ 注意事项

1. **备份配置**：修改前请备份相关配置文件
2. **测试环境**：建议先在测试环境验证
3. **业务影响**：某些配置可能影响业务功能，需要评估
4. **IPv6 配置**：如果服务器需要 IPv6，相关配置需要调整
5. **重启要求**：部分配置需要重启服务器才能生效

## 📝 修复后验证

修复完成后，建议：
1. 重新运行安全扫描
2. 验证业务功能正常
3. 检查系统日志是否有异常
4. 定期进行安全扫描

## ✅ 修复执行记录

**修复时间：** 2025-12-06  
**修复状态：** 已完成

### 已修复的项目

1. ✅ **IPv6 源路由数据包** - 已禁用
   - 配置：`net.ipv6.conf.all.accept_source_route = 0`
   - 状态：已生效

2. ✅ **IPv6 路由器通告** - 已禁用
   - 配置：`net.ipv6.conf.all.accept_ra = 0`
   - 状态：已生效

3. ✅ **核心转储限制** - 已配置
   - 配置：`fs.suid_dumpable = 0` 和 `limits.conf` 设置
   - 状态：已生效

4. ✅ **DCCP 内核模块** - 已禁用
   - 配置：已添加到 `/etc/modprobe.d/blacklist.conf`
   - 状态：已生效

5. ✅ **/tmp nosuid 配置** - 系统默认正常
   - 状态：系统使用默认配置，无需额外设置

### 需要说明的项目

**root 用户空密码检测：**
- **状态：** 这是正常的，不是安全风险
- **说明：** Ubuntu 系统默认禁用 root 用户（通过 `!` 或 `*` 标记），这是安全最佳实践
- **建议：** 继续使用 `sudo` 来执行需要 root 权限的操作，不要启用 root 用户
- **验证：** root 用户无法直接登录，只能通过 sudo 使用

### 配置文件备份

所有修改的配置文件已自动备份：
- `/etc/sysctl.conf.bak.*`
- `/etc/security/limits.conf.bak.*`

### 修复后建议

1. **重新运行安全扫描**：在宝塔面板中重新扫描，验证修复效果
2. **重启服务器**（可选）：部分配置需要重启才能完全生效，但当前配置已通过 `sysctl -p` 立即生效
3. **定期检查**：建议定期运行安全扫描，及时发现新的安全风险

---

**建议：** 对于生产环境，建议修复所有高危和中危风险。对于开发/测试环境，至少修复高危风险。

**修复完成度：** 中危风险已全部修复 ✅

