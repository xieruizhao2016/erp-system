# SSHè¿žæŽ¥é—®é¢˜æŽ’æŸ¥æŒ‡å—

## ðŸ” é—®é¢˜ï¼šSSHè¿žæŽ¥è¶…æ—¶æˆ–æ— æ³•è¿žæŽ¥

### å¯èƒ½åŽŸå› 

1. **SSHè¿žæŽ¥æ•°è¿‡å¤š** - æœåŠ¡å™¨è¾¾åˆ°æœ€å¤§è¿žæŽ¥æ•°é™åˆ¶
2. **ç½‘ç»œé—®é¢˜** - é˜²ç«å¢™æˆ–å®‰å…¨ç»„é…ç½®é—®é¢˜
3. **SSHæœåŠ¡å¼‚å¸¸** - SSHå®ˆæŠ¤è¿›ç¨‹å‡ºçŽ°é—®é¢˜

---

## ðŸ“‹ æ£€æŸ¥æ­¥éª¤

### æ–¹æ³•1ï¼šé€šè¿‡ç«å±±å¼•æ“ŽæŽ§åˆ¶å°ï¼ˆæŽ¨èï¼‰

å¦‚æžœSSHæ— æ³•è¿žæŽ¥ï¼Œå¯ä»¥é€šè¿‡ç«å±±å¼•æ“ŽæŽ§åˆ¶å°çš„VNCæˆ–Webç»ˆç«¯è®¿é—®ï¼š

1. ç™»å½•ç«å±±å¼•æ“ŽæŽ§åˆ¶å°
2. è¿›å…¥äº‘æœåŠ¡å™¨å®žä¾‹ç®¡ç†é¡µé¢
3. æ‰¾åˆ°æœåŠ¡å™¨ `115.190.240.137`
4. ä½¿ç”¨"è¿œç¨‹è¿žæŽ¥"æˆ–"VNC"åŠŸèƒ½è¿›å…¥æœåŠ¡å™¨

### æ–¹æ³•2ï¼šæ£€æŸ¥SSHè¿žæŽ¥æ•°ï¼ˆéœ€è¦å…ˆèƒ½è¿žæŽ¥ï¼‰

å¦‚æžœèƒ½é€šè¿‡å…¶ä»–æ–¹å¼è¿žæŽ¥ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼š

```bash
# æŸ¥çœ‹å½“å‰SSHè¿žæŽ¥æ•°
who | wc -l

# æŸ¥çœ‹å½“å‰SSHä¼šè¯è¯¦æƒ…
who

# æŸ¥çœ‹SSHè¿›ç¨‹æ•°
ps aux | grep sshd | grep -v grep | wc -l

# æŸ¥çœ‹SSHå®ˆæŠ¤è¿›ç¨‹é…ç½®
grep -E '^MaxStartups|^MaxSessions' /etc/ssh/sshd_config

# æŸ¥çœ‹SSHè¿žæŽ¥æ—¥å¿—
tail -50 /var/log/auth.log
# æˆ–
tail -50 /var/log/secure
```

---

## ðŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ¸…ç†SSHè¿žæŽ¥ï¼ˆæŽ¨èï¼‰

å¦‚æžœèƒ½é€šè¿‡æŽ§åˆ¶å°è¿žæŽ¥ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰SSHè¿žæŽ¥
who

# æŸ¥çœ‹SSHè¿›ç¨‹
ps aux | grep sshd

# å¼ºåˆ¶æ–­å¼€æ‰€æœ‰éžå½“å‰ä¼šè¯ï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
# å…ˆæŸ¥çœ‹å½“å‰ä¼šè¯çš„TTY
tty

# æ–­å¼€å…¶ä»–ä¼šè¯ï¼ˆæ›¿æ¢ä¸ºå®žé™…çš„TTYï¼‰
pkill -9 -t pts/1  # ç¤ºä¾‹ï¼Œæ ¹æ®å®žé™…æƒ…å†µä¿®æ”¹

# æˆ–è€…é‡å¯SSHæœåŠ¡ï¼ˆä¼šæ–­å¼€æ‰€æœ‰è¿žæŽ¥ï¼‰
systemctl restart sshd
```

### æ–¹æ¡ˆ2ï¼šè°ƒæ•´SSHé…ç½®

ç¼–è¾‘SSHé…ç½®æ–‡ä»¶ï¼š

```bash
# ç¼–è¾‘SSHé…ç½®
vi /etc/ssh/sshd_config

# ä¿®æ”¹æˆ–æ·»åŠ ä»¥ä¸‹é…ç½®
MaxStartups 10:30:100  # å…è®¸10ä¸ªæœªè®¤è¯è¿žæŽ¥ï¼Œ30ç§’å†…æœ€å¤š30ä¸ªï¼Œæœ€å¤š100ä¸ª
MaxSessions 10         # æ¯ä¸ªè¿žæŽ¥æœ€å¤š10ä¸ªä¼šè¯
MaxStartups 50         # ç®€åŒ–é…ç½®ï¼šæœ€å¤š50ä¸ªæœªè®¤è¯è¿žæŽ¥

# ä¿å­˜åŽé‡å¯SSHæœåŠ¡
systemctl restart sshd
```

**é…ç½®è¯´æ˜Žï¼š**
- `MaxStartups`: æŽ§åˆ¶æœªè®¤è¯è¿žæŽ¥æ•°ï¼Œæ ¼å¼ä¸º `start:rate:full`
  - `start`: å¼€å§‹æ‹’ç»æ–°è¿žæŽ¥çš„é˜ˆå€¼
  - `rate`: æ‹’ç»æ–°è¿žæŽ¥çš„é€ŸçŽ‡ï¼ˆæ¯ç§’ï¼‰
  - `full`: å®Œå…¨æ‹’ç»æ–°è¿žæŽ¥çš„æœ€å¤§æ•°
- `MaxSessions`: æ¯ä¸ªSSHè¿žæŽ¥å…è®¸çš„æœ€å¤§ä¼šè¯æ•°

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥å¹¶ä¼˜åŒ–SSHè¿žæŽ¥

```bash
# æŸ¥çœ‹SSHè¿žæŽ¥è¶…æ—¶é…ç½®
grep -E '^ClientAliveInterval|^ClientAliveCountMax' /etc/ssh/sshd_config

# å¦‚æžœä¸å­˜åœ¨ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆè‡ªåŠ¨æ–­å¼€ç©ºé—²è¿žæŽ¥ï¼‰
ClientAliveInterval 300    # æ¯300ç§’å‘é€ä¸€æ¬¡ä¿æ´»æ¶ˆæ¯
ClientAliveCountMax 2      # æœ€å¤šå‘é€2æ¬¡ï¼Œè¶…è¿‡åˆ™æ–­å¼€è¿žæŽ¥

# é‡å¯SSHæœåŠ¡
systemctl restart sshd
```

### æ–¹æ¡ˆ4ï¼šæ£€æŸ¥é˜²ç«å¢™å’Œå®‰å…¨ç»„

```bash
# æ£€æŸ¥SSHç«¯å£æ˜¯å¦å¼€æ”¾
netstat -tlnp | grep :22

# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
iptables -L -n | grep 22
# æˆ–
firewall-cmd --list-all

# æ£€æŸ¥SSHæœåŠ¡çŠ¶æ€
systemctl status sshd
```

---

## ðŸš¨ ç´§æ€¥å¤„ç†

å¦‚æžœå®Œå…¨æ— æ³•è¿žæŽ¥ï¼Œä¸”æ— æ³•é€šè¿‡æŽ§åˆ¶å°è®¿é—®ï¼š

1. **é€šè¿‡ç«å±±å¼•æ“ŽæŽ§åˆ¶å°é‡å¯æœåŠ¡å™¨**
   - ç™»å½•ç«å±±å¼•æ“ŽæŽ§åˆ¶å°
   - æ‰¾åˆ°å¯¹åº”å®žä¾‹
   - æ‰§è¡Œé‡å¯æ“ä½œ

2. **æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™**
   - ç¡®ä¿22ç«¯å£å·²å¼€æ”¾
   - æ£€æŸ¥IPç™½åå•è®¾ç½®

3. **è”ç³»ç«å±±å¼•æ“ŽæŠ€æœ¯æ”¯æŒ**
   - æä¾›æœåŠ¡å™¨IPå’Œé—®é¢˜æè¿°
   - è¯·æ±‚ååŠ©æ£€æŸ¥SSHæœåŠ¡çŠ¶æ€

---

## ðŸ“ é¢„é˜²æŽªæ–½

### 1. å®šæœŸæ¸…ç†SSHè¿žæŽ¥

åˆ›å»ºæ¸…ç†è„šæœ¬ï¼š

```bash
# åˆ›å»ºæ¸…ç†è„šæœ¬
cat > /usr/local/bin/cleanup-ssh.sh << 'EOF'
#!/bin/bash
# æ¸…ç†è¶…è¿‡1å°æ—¶çš„ç©ºé—²SSHè¿žæŽ¥
who | awk '{print $1, $2, $5}' | while read user tty time; do
    if [ -n "$time" ]; then
        # æ£€æŸ¥è¿žæŽ¥æ—¶é—´ï¼Œå¦‚æžœè¶…è¿‡1å°æ—¶åˆ™æ–­å¼€
        # è¿™é‡Œéœ€è¦æ ¹æ®å®žé™…æƒ…å†µè°ƒæ•´é€»è¾‘
        echo "æ£€æŸ¥è¿žæŽ¥: $user on $tty"
    fi
done
EOF

chmod +x /usr/local/bin/cleanup-ssh.sh
```

### 2. é…ç½®SSHè¿žæŽ¥ç›‘æŽ§

```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
echo "0 * * * * /usr/local/bin/cleanup-ssh.sh" | crontab -
```

### 3. ä½¿ç”¨SSHå¯†é’¥è®¤è¯è€Œéžå¯†ç è®¤è¯

```bash
# åœ¨æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆå¦‚æžœè¿˜æ²¡æœ‰ï¼‰
ssh-keygen -t rsa -b 4096

# å°†å…¬é’¥å¤åˆ¶åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/id_rsa.pub root@115.190.240.137

# ç¦ç”¨å¯†ç è®¤è¯ï¼ˆå¯é€‰ï¼Œæé«˜å®‰å…¨æ€§ï¼‰
# ç¼–è¾‘ /etc/ssh/sshd_config
# PasswordAuthentication no
# ç„¶åŽé‡å¯SSHæœåŠ¡
```

---

## ðŸ”— ç›¸å…³æ–‡æ¡£

- [ç«å±±å¼•æ“Žå¿«é€Ÿå¼€å§‹](./ç«å±±å¼•æ“Žå¿«é€Ÿå¼€å§‹.md)
- [éƒ¨ç½²æ£€æŸ¥æ¸…å•](./éƒ¨ç½²æ£€æŸ¥æ¸…å•.md)

---

**æœ€åŽæ›´æ–°**: 2025-12-05

