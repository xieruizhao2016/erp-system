# 前端构建优化说明

## 🎯 优化目标

解决前端构建时间过长的问题，将构建时间从 **15-30 分钟** 降低到 **3-8 分钟**（首次构建）或 **1-3 分钟**（增量构建）。

## 📊 优化措施

### 1. Dockerfile 层缓存优化 ✅

**问题**：每次构建都重新安装依赖，即使 `package.json` 没有变化。

**解决方案**：
- 将依赖安装步骤与源代码复制分离
- 使用 Docker BuildKit 的缓存挂载功能
- 充分利用 Docker 层缓存机制

**优化效果**：
- 依赖未变化时：跳过依赖安装步骤（节省 5-10 分钟）
- 仅源代码变化时：只重新构建，不重新安装依赖（节省 5-10 分钟）

**关键改进**：
```dockerfile
# 使用缓存挂载加速依赖安装
RUN --mount=type=cache,id=pnpm-store,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# 使用缓存挂载加速 Vite 构建缓存
RUN --mount=type=cache,id=vite-cache,target=/app/node_modules/.vite \
    pnpm build:prod
```

### 2. .dockerignore 文件 ✅

**问题**：复制了大量不必要的文件（如 `node_modules`、`dist`、`.git` 等），增加了构建上下文大小。

**解决方案**：
- 创建 `.dockerignore` 文件
- 排除不必要的文件和目录

**优化效果**：
- 减少构建上下文大小（从几百 MB 降低到几十 MB）
- 加速文件复制步骤（节省 1-2 分钟）

### 3. Vite 构建配置优化 ✅

**问题**：
- 使用 `terser` 压缩，速度较慢
- 未充分利用多核 CPU 并行构建

**解决方案**：
- 使用 `esbuild` 替代 `terser`（速度提升 10-20 倍）
- 启用并行构建优化
- 优化 chunk 分割策略

**优化效果**：
- 压缩速度提升 10-20 倍（从 5-10 分钟降低到 30 秒-1 分钟）
- 整体构建时间减少 40-60%

**注意**：
- `esbuild` 压缩率略低于 `terser`（通常差异 < 5%）
- 如需更好的压缩率，可通过环境变量 `VITE_MINIFY=terser` 切换回 `terser`

## 🚀 使用方法

### 启用 BuildKit（推荐）

BuildKit 是 Docker 的新构建引擎，支持缓存挂载等高级功能。

**启用方式**：

1. **设置环境变量**（临时）：
```bash
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
```

2. **或在构建命令中启用**：
```bash
DOCKER_BUILDKIT=1 docker compose build admin
```

3. **或在 `~/.docker/config.json` 中永久启用**：
```json
{
  "features": {
    "buildkit": true
  }
}
```

### 构建命令

**本地构建**：
```bash
# 启用 BuildKit
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# 构建前端镜像
cd script/docker
docker compose -f docker-compose.prod.yml build admin
```

**服务器构建**：
```bash
# 在服务器上执行
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
cd /opt/erp-system/script/docker
docker compose -f docker-compose.prod.yml --env-file .env build admin
```

### 使用构建脚本

**本地构建脚本**（已自动启用 BuildKit）：
```bash
./deploy/scripts/build-frontend-local.sh
```

**服务器构建脚本**：
```bash
./deploy/scripts/build-frontend-on-server.sh
```

## ⏱️ 预期构建时间

### 首次构建（无缓存）
- **优化前**：15-30 分钟
- **优化后**：5-10 分钟
- **提升**：50-70%

### 依赖未变化（仅源代码变化）
- **优化前**：15-30 分钟（每次都重新安装依赖）
- **优化后**：1-3 分钟（跳过依赖安装）
- **提升**：80-90%

### 仅修改少量文件
- **优化前**：15-30 分钟
- **优化后**：30 秒-2 分钟（充分利用缓存）
- **提升**：90-95%

## 🔍 验证优化效果

### 查看构建时间

构建时会显示各步骤的耗时：
```bash
docker compose build admin
```

### 查看缓存使用情况

```bash
# 查看 Docker 缓存
docker system df -v

# 查看构建缓存
docker builder du
```

### 测试缓存效果

1. **首次构建**（记录时间）：
```bash
time docker compose build admin
```

2. **修改一个源文件**（如 `src/App.vue`）：
```bash
echo "// test" >> original-yudao-ui/src/App.vue
```

3. **再次构建**（应该只重新构建，不重新安装依赖）：
```bash
time docker compose build admin
```

## ⚠️ 注意事项

### 1. BuildKit 兼容性

- Docker 版本需要 >= 18.09
- 如果服务器 Docker 版本较旧，可能需要升级

### 2. 缓存清理

如果遇到依赖问题，可以清理缓存：
```bash
# 清理构建缓存
docker builder prune

# 清理所有未使用的缓存
docker system prune -a
```

### 3. 压缩算法选择

- **默认使用 `esbuild`**：速度快，压缩率略低（推荐）
- **使用 `terser`**：速度慢，压缩率更高（如需最小体积）

切换方式：
```bash
# 在 .env 文件中设置
VITE_MINIFY=terser
```

### 4. 网络问题

如果依赖安装失败，检查：
- npm 镜像源配置（已在 Dockerfile 中配置为 `registry.npmmirror.com`）
- 服务器网络连接
- 防火墙设置

## 📈 进一步优化建议

### 1. 使用多阶段构建缓存

如果经常构建，可以考虑使用外部缓存：
```bash
docker buildx build --cache-from type=local,src=/tmp/.buildx-cache \
  --cache-to type=local,dest=/tmp/.buildx-cache \
  -t yudao-admin:latest .
```

### 2. CI/CD 优化

在 CI/CD 环境中：
- 使用共享的构建缓存
- 并行构建多个服务
- 使用构建缓存服务（如 GitHub Actions Cache）

### 3. 依赖优化

定期检查并清理未使用的依赖：
```bash
cd original-yudao-ui
pnpm why <package-name>  # 查看依赖原因
pnpm update              # 更新依赖
```

## 🐛 问题排查

### 构建仍然很慢

1. **检查是否启用了 BuildKit**：
```bash
docker version | grep BuildKit
```

2. **检查缓存是否生效**：
```bash
docker compose build --progress=plain admin
```

3. **检查网络连接**：
```bash
docker run --rm alpine ping -c 3 registry.npmmirror.com
```

### 依赖安装失败

1. **检查镜像源配置**：
```bash
docker run --rm node:18-alpine npm config get registry
```

2. **手动测试依赖安装**：
```bash
cd original-yudao-ui
pnpm install
```

## 📝 总结

通过以上优化措施，前端构建时间可以显著降低：

- ✅ **Docker 层缓存**：节省 5-10 分钟（依赖未变化时）
- ✅ **.dockerignore**：节省 1-2 分钟（减少构建上下文）
- ✅ **esbuild 压缩**：节省 4-9 分钟（压缩速度提升）
- ✅ **BuildKit 缓存挂载**：节省 2-5 分钟（依赖和构建缓存）

**总体提升**：构建时间减少 **60-90%**，从 15-30 分钟降低到 1-10 分钟（取决于缓存情况）。

