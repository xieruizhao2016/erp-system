# 服务器代码清理指南

## 📋 概述

本指南说明如何清理云服务器上的源代码，改为使用**本地构建 + 上传部署**的方式。

## ✅ 为什么可以删除服务器上的代码？

1. **当前部署方式已经是本地构建**
   - 项目已有 `scripts/deploy-prod.sh` 脚本
   - 该脚本在本地构建前端和后端
   - 然后上传构建产物到服务器

2. **服务运行不依赖源代码**
   - 服务通过 Docker 容器运行
   - 容器使用已构建的镜像
   - 只需要上传的 JAR 包和前端静态文件

3. **节省服务器资源**
   - 源代码占用约 860MB 磁盘空间
   - 删除后可以释放空间
   - 减少服务器资源消耗

## 🗂️ 保留的文件

清理后会保留以下必要文件：

| 目录/文件 | 用途 | 是否必需 |
|----------|------|---------|
| `/opt/erp-system/script/docker/` | Docker Compose 配置和 `.env` 文件 | ✅ 必需 |
| `/opt/erp-system/yudao-server/target/` | 存放上传的 JAR 包 | ✅ 必需 |
| `/opt/erp-system/sql/` | 数据库初始化脚本 | ⚠️ 建议保留 |
| `/opt/erp-system/deploy/` | 部署脚本和文档 | ⚠️ 可选 |

## 🗑️ 删除的文件

以下内容会被删除：

- ✅ 所有后端源代码模块（`yudao-*`）
- ✅ 前端源代码（`original-yudao-ui/src`）
- ✅ 构建产物（`target/classes` 等，但保留 `target/` 目录）
- ✅ 代码生成输出（`codegen-*`）
- ✅ Git 相关文件（`.git`, `.gitee`, `.github`）
- ✅ 文档和图片（`docs/`, `.image/`）

## 🚀 使用方法

### 方法1：使用清理脚本（推荐）

```bash
# 在本地执行
cd /Users/xierui/Documents/Project/Other/erp-system
./deploy/scripts/cleanup-server-code.sh
```

脚本会：
1. 检查当前磁盘使用情况
2. 备份重要文件（Docker配置、SQL脚本等）
3. 删除源代码目录
4. 验证清理结果

### 方法2：手动清理

如果需要手动清理，可以SSH到服务器执行：

```bash
ssh -i tengxunyun.pem ubuntu@101.33.244.240

cd /opt/erp-system

# 备份重要文件（可选）
mkdir -p /opt/erp-system-backup
cp -r script/docker /opt/erp-system-backup/
cp -r sql /opt/erp-system-backup/

# 删除源代码
rm -rf yudao-dependencies yudao-framework yudao-module-* yudao-server/src
rm -rf original-yudao-ui/src original-yudao-ui/build original-yudao-ui/dist-prod
rm -rf codegen-* .gitee .github .image docs scripts

# 确保必要目录存在
mkdir -p yudao-server/target
mkdir -p script/docker
mkdir -p sql/mysql
```

## 📦 后续部署流程

清理后，使用本地构建部署脚本：

```bash
# 在本地执行
cd /Users/xierui/Documents/Project/Other/erp-system

# 一键部署（本地构建 + 上传 + 部署）
./scripts/deploy-prod.sh
```

该脚本会：
1. ✅ 在本地构建前端（`pnpm build:prod`）
2. ✅ 在本地构建后端（`mvn clean package`）
3. ✅ 上传前端文件到 `/tmp/dist-prod/`
4. ✅ 上传后端 JAR 到 `/opt/erp-system/yudao-server/target/`
5. ✅ 更新 Docker 容器并重启服务

## ⚠️ 注意事项

1. **备份重要文件**
   - 清理脚本会自动备份 Docker 配置和 SQL 脚本
   - 备份位置：`/opt/erp-system-backup-YYYYMMDD-HHMMSS/`

2. **保留必要的目录结构**
   - `yudao-server/target/` 目录必须存在（用于存放上传的JAR包）
   - `script/docker/` 目录必须存在（Docker Compose配置）

3. **首次部署后清理**
   - 建议在首次部署成功并验证后，再执行清理
   - 确保服务正常运行后再删除源代码

4. **恢复代码**
   - 如果需要恢复代码，可以从 Git 仓库重新克隆
   - 或从备份目录恢复

## 🔍 验证清理结果

清理后可以验证：

```bash
ssh -i tengxunyun.pem ubuntu@101.33.244.240

# 检查目录大小
du -sh /opt/erp-system

# 检查保留的目录
ls -la /opt/erp-system/

# 检查服务状态
docker ps | grep yudao
```

## 📊 预期效果

| 项目 | 清理前 | 清理后 | 节省 |
|------|--------|--------|------|
| 目录大小 | ~860MB | ~50-100MB | ~760MB |
| 磁盘使用率 | 72% | ~68% | -4% |

## 🆘 常见问题

### Q1: 清理后服务还能正常运行吗？

**A:** 可以。服务通过 Docker 容器运行，不依赖源代码。只需要确保：
- Docker 容器正常运行
- `.env` 配置文件存在
- 上传的 JAR 包在正确位置

### Q2: 如何更新服务？

**A:** 使用本地部署脚本：
```bash
./scripts/deploy-prod.sh
```

### Q3: 如果误删了重要文件怎么办？

**A:** 清理脚本会自动备份，可以从备份目录恢复：
```bash
# 查看备份
ls -la /opt/erp-system-backup-*/

# 恢复文件
cp -r /opt/erp-system-backup-*/script/docker /opt/erp-system/
```

### Q4: 可以只删除部分代码吗？

**A:** 可以。可以手动删除不需要的目录，但建议保留：
- `script/docker/` - Docker配置
- `yudao-server/target/` - JAR包目录
- `sql/` - 数据库脚本

---

**最后更新：** 2025-12-21  
**适用服务器：** 腾讯云 (101.33.244.240)

