# 系统租户菜单不显示 - 最终排查方案

## 🔍 问题确认

- ✅ 数据库配置正常（菜单已创建，状态正确）
- ✅ 角色权限已分配（16个角色都有权限）
- ✅ 父菜单存在且正常
- ✅ 菜单排序正常
- ❌ **但API响应中没有新菜单**

## 🎯 可能的原因

### 1. 后端代码使用了 `getMenuListByTenant` 方法

从代码分析看，`MenuServiceImpl.getMenuListByTenant` 方法会调用 `tenantService.handleTenantMenu` 来过滤菜单。

**检查点**：
- 系统租户（id=1, package_id=0）应该能看到所有菜单
- 但如果代码逻辑有问题，可能会过滤掉新菜单

### 2. 菜单查询时的过滤逻辑

后端在 `AuthController.getPermissionInfo` 中：
1. 获取角色菜单ID列表
2. 调用 `menuService.getMenuList(menuIds)` 查询菜单
3. 调用 `menuService.filterDisableMenus(menuList)` 过滤禁用菜单

**可能的问题**：
- `filterDisableMenus` 方法可能过滤掉了新菜单
- 菜单树构建时可能有问题

### 3. 后端代码需要重新编译

如果后端代码有修改，可能需要重新编译才能生效。

## 🛠️ 解决方案

### 方案1：检查并修复菜单查询逻辑

检查 `filterDisableMenus` 方法是否错误地过滤了新菜单。

### 方案2：重新编译后端代码

```bash
cd /Users/xierui/Documents/Project/Other/erp-system
mvn clean package -DskipTests
./scripts/dev/start-backend.sh -d
```

### 方案3：直接修改数据库，确保菜单在查询结果中

检查菜单的 `deleted` 字段是否为 0（未删除）。

### 方案4：检查菜单的创建时间

新菜单的创建时间可能影响查询结果。

## 📋 立即执行的检查

### 检查1：验证菜单是否在角色权限中

```sql
SELECT 
    m.id,
    m.name,
    COUNT(rm.role_id) as role_count
FROM system_menu m
LEFT JOIN system_role_menu rm ON m.id = rm.menu_id AND rm.role_id = 1
WHERE m.id IN (6376, 6382, 6412, 6419)
GROUP BY m.id, m.name;
```

### 检查2：模拟后端查询

```sql
-- 获取角色1的所有菜单ID
SELECT menu_id 
FROM system_role_menu 
WHERE role_id = 1 
  AND menu_id IN (6376, 6382, 6412, 6419);
```

### 检查3：检查菜单的deleted字段

```sql
SELECT id, name, deleted 
FROM system_menu 
WHERE id IN (6376, 6382, 6412, 6419);
```

## 🔧 如果以上都不行

可能需要：

1. **查看后端日志**，看是否有错误信息
2. **检查后端代码**，看菜单查询的具体实现
3. **重新编译后端代码**，确保代码是最新的
4. **检查菜单的创建时间**，看是否影响查询

## 📞 需要的信息

如果问题仍然存在，请提供：

1. **后端日志**（`tail -200 nohup.out`）
2. **完整的API响应**（包括所有菜单）
3. **菜单查询的SQL日志**（如果开启了SQL日志）

