# 重新部署后端指南

## 📌 为什么需要重新部署？

我们今天新增了大量后端Java代码：
- ✅ SKU管理模块
- ✅ 产品包装模块  
- ✅ 产品OEM模块

**共计新增**：
- 24个Java类文件（DO + Mapper + Service + Controller + VO）
- 3个MyBatis XML映射文件
- 错误码定义

**现状**：
- 当前运行的jar包编译时间：**2024-11-20 17:47**
- 新增代码时间：**2024-11-21**
- **结论**：后端服务运行的是旧代码，新增的模块不会生效！

---

## 🚀 快速重新部署

### 方法1：使用一键脚本（推荐）

```bash
cd /Users/xierui/Documents/Project/erp-system
./rebuild-and-restart.sh
```

这个脚本会自动完成：
1. ✅ 停止当前运行的后端服务
2. ✅ 清理旧的编译文件
3. ✅ 重新编译打包（mvn clean package）
4. ✅ 启动新的后端服务

**预计时间**：3-5分钟

---

### 方法2：手动执行（详细步骤）

#### 步骤1：停止后端服务
```bash
cd /Users/xierui/Documents/Project/erp-system

# 查找并停止Java进程
PID=$(lsof -ti :48080)
kill $PID

# 验证已停止
lsof -i :48080
```

#### 步骤2：清理旧文件
```bash
# 清理编译文件
rm -rf yudao-server/target
find . -type d -name "target" -not -path "./node_modules/*" -not -path "./original-yudao-ui/*" -exec rm -rf {} + 2>/dev/null
```

#### 步骤3：重新编译打包
```bash
# 编译打包（跳过测试，加快速度）
mvn clean package -DskipTests -T 1C
```

**编译时间**：
- 首次编译：5-10分钟
- 增量编译：2-3分钟

**常见问题**：
- 如果提示找不到mvn命令，需要先安装Maven
- 如果编译失败，检查Java版本（需要JDK 8或更高）

#### 步骤4：验证jar包
```bash
ls -lh yudao-server/target/yudao-server.jar
```

应该看到新生成的jar包（约228MB）

#### 步骤5：启动后端服务
```bash
# 后台启动
./start-backend.sh -d

# 查看日志
tail -f nohup.out
```

---

## ✅ 验证部署成功

### 1. 检查服务启动
```bash
# 检查端口是否监听
lsof -i :48080

# 检查进程
ps aux | grep yudao-server | grep -v grep
```

### 2. 检查日志
```bash
tail -f nohup.out
```

**成功标志**：
- 看到"Started YudaoServerApplication"
- 没有报错信息
- 端口48080被监听

### 3. 测试新模块API

#### 测试产品包装API
```bash
curl -X GET "http://127.0.0.1:48080/admin-api/erp/product-package/simple-list" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "tenant-id: 1"
```

#### 测试产品OEM API
```bash
curl -X GET "http://127.0.0.1:48080/admin-api/erp/product-oem/simple-list" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "tenant-id: 1"
```

**预期结果**：返回200状态码和JSON数据

---

## 🎯 前端刷新

重新部署后端后，前端也需要刷新：

### 1. 清除浏览器缓存
- **Mac**: `Cmd + Shift + R`
- **Windows**: `Ctrl + Shift + R`

### 2. 重启前端开发服务器（如果需要）
```bash
cd original-yudao-ui

# 停止当前运行（Ctrl+C）

# 重新启动
npm run dev
```

### 3. 验证新功能
登录系统后，检查左侧菜单是否出现：
- ✅ SKU管理
- ✅ 产品包装
- ✅ 产品OEM

---

## 🔧 常见问题

### Q1: 编译时提示"找不到Maven"
**解决**：
```bash
# Mac安装Maven
brew install maven

# 验证安装
mvn -version
```

### Q2: 编译失败，提示Java版本问题
**解决**：
```bash
# 检查Java版本
java -version

# 需要JDK 8或更高版本
# Mac安装JDK 8
brew install openjdk@8
```

### Q3: 端口48080被占用
**解决**：
```bash
# 查找占用进程
lsof -i :48080

# 停止进程
kill $(lsof -ti :48080)
```

### Q4: 启动后立即停止
**解决**：
```bash
# 查看完整日志
cat nohup.out

# 常见原因：
# - 数据库连接失败
# - Redis连接失败
# - 端口被占用
```

### Q5: 新增的菜单看不到
**解决**：
1. 确认菜单SQL已执行
2. 清除浏览器缓存
3. 重新登录系统
4. 检查角色权限

---

## 📊 性能优化建议

### 加快编译速度
```bash
# 使用多线程编译（-T 1C表示每个CPU核心一个线程）
mvn clean package -DskipTests -T 1C

# 只编译特定模块
mvn clean package -DskipTests -pl yudao-module-erp -am
```

### 开发模式建议
如果频繁修改代码，建议使用IDE直接运行：
1. IDEA中打开项目
2. 运行YudaoServerApplication
3. 修改代码后直接重启

---

## 🎉 部署完成检查清单

部署完成后，请确认：

- [ ] 后端服务正常启动（端口48080监听）
- [ ] 日志无错误信息
- [ ] 前端已刷新缓存
- [ ] 新菜单可见（SKU管理、产品包装、产品OEM）
- [ ] 产品表单中有新字段（SKU、包装、OEM下拉框）
- [ ] 可以创建和查询新模块数据

全部完成即表示部署成功！🎊

---

## 📞 技术支持

如遇到问题：
1. 查看本文档的常见问题部分
2. 检查nohup.out日志文件
3. 验证数据库和Redis连接

---

**最后更新**：2025-11-21

