# 内部出入库业务逻辑完成总结

**完成时间**: 2025-12-09  
**状态**: ✅ 已完成

---

## ✅ 已完成的工作

### 1. 内部入库业务逻辑

- ✅ **明细项文件**: 创建了`ErpStockInternalInItemDO`和`ErpStockInternalInItemMapper`
- ✅ **明细项校验**: 校验产品和仓库存在，自动填充单位ID和金额
- ✅ **明细项处理**: 支持新增、修改、删除明细项
- ✅ **库存记录创建**: 审核通过时创建库存记录（增加库存），反审核时取消（减少库存）
- ✅ **创建和更新逻辑**: 自动计算合计数量和金额
- ✅ **审核状态更新**: 实现了`updateStockInternalInStatus`方法
- ✅ **SaveReqVO增强**: 添加了`items`字段和`Item`内部类

### 2. 内部出库业务逻辑

- ✅ **明细项文件**: 创建了`ErpStockInternalOutItemDO`和`ErpStockInternalOutItemMapper`
- ✅ **明细项校验**: 校验产品和仓库存在，自动填充单位ID和金额
- ✅ **明细项处理**: 支持新增、修改、删除明细项
- ✅ **库存记录创建**: 审核通过时创建库存记录（减少库存，数量为负数），反审核时取消（恢复库存）
- ✅ **创建和更新逻辑**: 自动计算合计数量和金额
- ✅ **审核状态更新**: 实现了`updateStockInternalOutStatus`方法
- ✅ **SaveReqVO增强**: 添加了`items`字段和`Item`内部类

### 3. Mapper方法

#### 内部入库Mapper
- ✅ `selectByNo` - 根据单号查询
- ✅ `updateByIdAndStatus` - 根据ID和状态更新

#### 内部出库Mapper
- ✅ `selectByNo` - 根据单号查询
- ✅ `updateByIdAndStatus` - 根据ID和状态更新

### 4. 单号生成

- ✅ `STOCK_INTERNAL_IN_NO_PREFIX = "NBRK"` (内部入库)
- ✅ `STOCK_INTERNAL_OUT_NO_PREFIX = "NBCK"` (内部出库)

### 5. 代码质量

- ✅ 修复了所有包名问题
- ✅ 无编译错误
- ✅ 代码结构清晰，参考了现有库存出入库实现

---

## 🔧 技术细节

### 库存记录创建逻辑

#### 内部入库
```java
// 审核通过：数量为正数（增加库存）
// 反审核：数量为负数（减少库存）
BigDecimal count = approve ? stockInternalInItem.getCount() 
        : stockInternalInItem.getCount().negate();
Integer bizType = approve ? ErpStockRecordBizTypeEnum.INTERNAL_IN.getType()
        : ErpStockRecordBizTypeEnum.INTERNAL_IN_CANCEL.getType();
```

#### 内部出库
```java
// 审核通过：数量为负数（减少库存）
// 反审核：数量为正数（恢复库存）
BigDecimal count = approve ? stockInternalOutItem.getCount().negate() 
        : stockInternalOutItem.getCount();
Integer bizType = approve ? ErpStockRecordBizTypeEnum.INTERNAL_OUT.getType()
        : ErpStockRecordBizTypeEnum.INTERNAL_OUT_CANCEL.getType();
```

### 明细项校验和处理

```java
// 1. 校验产品存在
List<ErpProductDO> productList = productService.validProductList(...);
// 2. 校验仓库存在
warehouseService.validWarehouseList(...);
// 3. 自动填充产品单位ID和合计金额
.setProductUnitId(productMap.get(item.getProductId()).getUnitId())
.setTotalPrice(MoneyUtils.priceMultiply(item.getProductPrice(), item.getCount()))
```

---

## 📁 相关文件

### 内部入库
- `ErpStockInternalInService/Impl` - 内部入库服务
- `ErpStockInternalInMapper` - 内部入库Mapper
- `ErpStockInternalInItemDO` - 内部入库明细项DO
- `ErpStockInternalInItemMapper` - 内部入库明细项Mapper
- `ErpStockInternalInSaveReqVO` - 内部入库保存请求VO

### 内部出库
- `ErpStockInternalOutService/Impl` - 内部出库服务
- `ErpStockInternalOutMapper` - 内部出库Mapper
- `ErpStockInternalOutItemDO` - 内部出库明细项DO
- `ErpStockInternalOutItemMapper` - 内部出库明细项Mapper
- `ErpStockInternalOutSaveReqVO` - 内部出库保存请求VO

---

## ⚠️ 注意事项

### 1. 错误码完善

部分错误码使用了占位符，建议添加：
- `STOCK_INTERNAL_IN_APPROVE_FAIL`
- `STOCK_INTERNAL_IN_PROCESS_FAIL`
- `STOCK_INTERNAL_IN_UPDATE_FAIL_APPROVE`
- `STOCK_INTERNAL_IN_NO_EXISTS`
- `STOCK_INTERNAL_OUT_APPROVE_FAIL`
- `STOCK_INTERNAL_OUT_PROCESS_FAIL`
- `STOCK_INTERNAL_OUT_UPDATE_FAIL_APPROVE`
- `STOCK_INTERNAL_OUT_NO_EXISTS`

### 2. 库存校验

内部出库时，建议添加库存充足性校验（参考`ErpStockOutServiceImpl`的实现）：
- 检查仓库库存是否足够
- 如果库存不足，抛出异常

---

## 📊 功能对比

| 功能 | 内部入库 | 内部出库 |
|------|---------|---------|
| 明细项支持 | ✅ | ✅ |
| 库存记录创建 | ✅ | ✅ |
| 审核状态更新 | ✅ | ✅ |
| 单号生成 | ✅ | ✅ |
| 合计计算 | ✅ | ✅ |
| 库存校验 | ⏳ | ⏳ |

---

**内部出入库业务逻辑已完成！** 🎉

现在可以继续实现其他业务功能（预付款/预收款、毛利率计算等）。

