# 菜单不显示 - 最终排查步骤

## 🔍 当前状态

所有数据库配置都是正确的：
- ✅ 菜单已创建（9个财务 + 9个库存）
- ✅ 菜单状态：启用（status=0）
- ✅ 菜单可见：是（visible=1）
- ✅ 菜单类型：菜单（type=2）
- ✅ 父菜单：启用且可见
- ✅ 角色权限：已分配

## 🎯 关键排查步骤

### 步骤1：检查浏览器API响应（最重要）

**这是最关键的一步，可以确定问题在哪里。**

1. **打开系统页面并登录**
2. **按 F12 打开开发者工具**
3. **进入 Network 标签**
4. **刷新页面（F5）**
5. **找到 `/admin-api/system/auth/get-permission-info` 请求**
6. **点击查看 Response（响应内容）**
7. **在响应中搜索以下内容**：
   - `"name":"应收账款"`
   - `"name":"应付账款"`
   - `"name":"内部入库"`
   - `"name":"内部出库"`

**判断结果**：

- **如果API响应中能找到这些菜单**：
  - ✅ 后端正常，菜单数据已返回
  - ❌ 问题在前端：缓存或路由生成
  - **解决方案**：使用下面的"强制清除前端缓存"方法

- **如果API响应中找不到这些菜单**：
  - ❌ 后端有问题，没有返回新菜单
  - **可能原因**：
    1. 后端缓存了旧的菜单数据
    2. 菜单过滤逻辑有问题
    3. 需要重新编译后端代码
  - **解决方案**：见下面的"修复后端菜单返回"部分

### 步骤2：强制清除前端缓存

如果API响应中有新菜单，但前端不显示，执行以下操作：

#### 方法A：浏览器控制台（最彻底）

1. **在已登录的系统页面**
2. **按 F12 → Console 标签**
3. **复制粘贴以下代码并回车**：

```javascript
// 清除所有缓存
localStorage.clear();
sessionStorage.clear();

// 清除菜单相关缓存
localStorage.removeItem('ROLE_ROUTERS');
localStorage.removeItem('USER');
localStorage.removeItem('LAYOUT');

// 强制刷新
location.reload(true);
```

4. **页面刷新后，重新登录**
5. **检查菜单**

#### 方法B：无痕模式测试

1. **关闭所有浏览器标签**
2. **打开无痕模式**：`Cmd+Shift+N` (Mac) / `Ctrl+Shift+N` (Windows)
3. **访问**：`http://localhost:5173`
4. **登录系统**
5. **检查菜单**

**如果无痕模式下能看到菜单** → 说明是缓存问题，使用方法A清除  
**如果无痕模式下也看不到** → 继续下面的步骤

### 步骤3：修复后端菜单返回

如果API响应中没有新菜单，执行以下操作：

#### 方法A：重启后端服务（清除后端缓存）

```bash
# 停止后端
pkill -f yudao-server

# 等待2秒
sleep 2

# 重新启动
cd /Users/xierui/Documents/Project/Other/erp-system
./scripts/dev/start-backend.sh -d

# 等待15秒
sleep 15
```

#### 方法B：检查后端日志

```bash
# 查看后端日志
tail -f nohup.out | grep -i "menu\|permission\|error"

# 或者查看最近的错误
tail -100 nohup.out | grep -i "error\|exception"
```

#### 方法C：重新编译后端（如果怀疑代码问题）

```bash
cd /Users/xierui/Documents/Project/Other/erp-system
mvn clean package -DskipTests
./scripts/dev/start-backend.sh -d
```

### 步骤4：检查前端路由生成

如果API响应中有新菜单，但前端路由没有生成，检查：

1. **打开浏览器控制台（F12）**
2. **在 Console 中执行**：

```javascript
// 检查菜单缓存
const roleRouters = localStorage.getItem('ROLE_ROUTERS');
if (roleRouters) {
    const menus = JSON.parse(roleRouters);
    console.log('菜单数据:', menus);
    
    // 递归查找菜单
    function findMenu(menus, name) {
        for (let menu of menus) {
            if (menu.name === name) {
                return menu;
            }
            if (menu.children) {
                const found = findMenu(menu.children, name);
                if (found) return found;
            }
        }
        return null;
    }
    
    console.log('应收账款:', findMenu(menus, '应收账款'));
    console.log('内部入库:', findMenu(menus, '内部入库'));
} else {
    console.log('❌ 没有找到菜单缓存数据');
}
```

## 📋 完整排查清单

按照以下顺序逐一检查：

- [ ] **步骤1**：检查Network标签中API响应是否包含新菜单
- [ ] **步骤2A**：如果API有菜单，使用浏览器控制台清除缓存
- [ ] **步骤2B**：使用无痕模式测试
- [ ] **步骤3**：如果API没有菜单，重启后端服务
- [ ] **步骤4**：检查前端路由生成
- [ ] **步骤5**：检查浏览器控制台是否有错误

## 🆘 如果以上都不行

请提供以下信息：

1. **API响应内容**（Network标签中 `/admin-api/system/auth/get-permission-info` 的完整JSON响应）
2. **浏览器控制台错误**（Console标签中的红色错误信息）
3. **无痕模式测试结果**（是否能看到菜单）
4. **后端日志**（`tail -100 nohup.out` 的最后100行）

## 💡 快速诊断

**最快的方法**：
1. 打开无痕模式
2. 登录系统
3. 检查菜单

**如果无痕模式能看到** → 缓存问题，清除缓存即可  
**如果无痕模式看不到** → 后端或前端代码问题，需要进一步排查

