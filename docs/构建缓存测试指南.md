# Docker 构建缓存测试指南

## 🎯 测试目标

验证优化后的 Dockerfile 是否能够有效利用 Docker 层缓存，在只修改代码时跳过依赖安装步骤。

## 📋 测试步骤

### 方法1：使用测试脚本（推荐）

```bash
cd /Users/RUIZHAO/Documents/Project/erp-system
./scripts/test-build-cache.sh
```

这个脚本会：
1. 执行首次构建（无缓存）
2. 模拟修改代码
3. 执行第二次构建（使用缓存）
4. 对比两次构建时间

### 方法2：手动测试

#### 步骤1：首次构建（建立缓存）

```bash
cd script/docker

# 记录开始时间
time docker-compose -f docker-compose.prod.yml build admin
```

**预期结果**：
- 会执行所有步骤：安装依赖、复制代码、构建
- 耗时：5-8分钟（取决于网络和机器性能）

#### 步骤2：修改代码（模拟代码变更）

```bash
# 修改任意一个前端文件
echo "// Test change" >> ../original-yudao-ui/src/main.ts
```

#### 步骤3：第二次构建（测试缓存）

```bash
# 记录开始时间
time docker-compose -f docker-compose.prod.yml build admin
```

**预期结果**：
- 依赖安装层显示 `CACHED` 或 `Using cache`
- 只重新执行：复制代码、构建步骤
- 耗时：2-3分钟（节省 60%+ 时间）

## 🔍 如何判断缓存是否生效？

### 1. 查看构建输出

**缓存生效的标志**：
```
Step 5/15 : RUN pnpm install --frozen-lockfile
 ---> Using cache
 ---> abc123def456
```

**未使用缓存的标志**：
```
Step 5/15 : RUN pnpm install --frozen-lockfile
 ---> Running in xyz789
```

### 2. 查看构建历史

```bash
docker history yudao-admin:latest --format "table {{.CreatedBy}}\t{{.Size}}"
```

如果看到多个层的大小相同，说明使用了缓存。

### 3. 查看构建时间

```bash
# 首次构建
time docker-compose build admin
# 输出: real 5m30s

# 第二次构建（只修改代码）
time docker-compose build admin
# 输出: real 2m15s  ← 时间明显减少
```

## 📊 预期效果

### 优化前
```
修改代码 → 重新安装依赖（3-5分钟）→ 重新构建（2-3分钟）
总时间：5-8分钟
```

### 优化后
```
修改代码 → 使用缓存（0秒）→ 重新构建（2-3分钟）
总时间：2-3分钟
节省时间：60%+
```

## ⚠️ 什么情况下缓存会失效？

### 1. 修改依赖文件
```bash
# 修改 package.json 或 pnpm-lock.yaml
vim original-yudao-ui/package.json
# 添加或删除依赖

# 构建时会重新安装依赖
docker-compose build admin
```

### 2. 修改 Dockerfile
```bash
# 修改 Dockerfile 的任何内容
vim original-yudao-ui/Dockerfile

# 从修改点开始的所有层都会重新构建
docker-compose build admin
```

### 3. 强制不使用缓存
```bash
# 使用 --no-cache 参数
docker-compose build --no-cache admin
```

## 🚀 在服务器上测试

### 1. 同步优化后的文件到服务器

```bash
# 同步 Dockerfile 和 .dockerignore
rsync -avz -e "ssh -i /path/to/key.pem" \
  original-yudao-ui/Dockerfile \
  original-yudao-ui/.dockerignore \
  ubuntu@your-server:/opt/erp-system/original-yudao-ui/
```

### 2. 在服务器上测试

```bash
ssh ubuntu@your-server

cd /opt/erp-system/script/docker

# 首次构建
time docker-compose -f docker-compose.prod.yml build admin

# 修改代码
echo "// test" >> /opt/erp-system/original-yudao-ui/src/main.ts

# 第二次构建（应该使用缓存）
time docker-compose -f docker-compose.prod.yml build admin
```

## 📝 测试检查清单

- [ ] 首次构建成功
- [ ] 第二次构建时依赖安装层显示 `CACHED`
- [ ] 构建时间明显减少（至少节省 50%）
- [ ] 构建产物正常（可以启动容器测试）

## 🔧 故障排查

### 问题1：缓存未生效

**可能原因**：
- Dockerfile 中层的顺序不对
- 修改了不应该修改的文件
- Docker 缓存被清理

**解决方法**：
```bash
# 检查 Dockerfile 层顺序
cat original-yudao-ui/Dockerfile

# 确保依赖安装在前，代码复制在后
# COPY package.json pnpm-lock.yaml ./
# RUN pnpm install
# COPY . .
```

### 问题2：构建时间没有明显减少

**可能原因**：
- 代码构建本身很慢
- 网络问题导致下载慢
- 机器性能限制

**解决方法**：
- 检查构建日志，看哪一步最慢
- 优化构建配置（减少不必要的优化）
- 使用更快的机器或 CI/CD 环境

## 📚 相关文档

- [Docker 构建缓存最佳实践](https://docs.docker.com/build/cache/)
- [前端构建优化说明](./前端构建优化说明.md)
- [Dockerfile 优化指南](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

