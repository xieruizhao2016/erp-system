# 新功能前端不显示问题排查指南

## 📋 问题描述

新开发的功能在数据库中已配置，但前端界面不显示。

## ✅ 已修复：财务管理模块菜单

**更新时间**: 2025-12-12

已为财务管理模块添加了缺失的菜单配置：

### 新增菜单（6个）
1. ✅ **应收账款** - `erp/finance/receivable/index`
2. ✅ **应付账款** - `erp/finance/payable/index`
3. ✅ **预付款** - `erp/finance/prepayment/index`
4. ✅ **预收款** - `erp/finance/prereceipt/index`
5. ✅ **资产负债表** - `erp/finance/balancesheet/index`
6. ✅ **利润表** - `erp/finance/profitstatement/index`

### 已有菜单（3个）
- 付款单
- 收款单
- 结算账户

**SQL脚本**: `sql/mysql/erp-finance-menus.sql`

**下一步操作**：
1. 清除浏览器缓存并重新登录
2. 在角色管理中为角色分配新菜单权限
3. 验证菜单是否正常显示

## ✅ 检查结果

根据检查脚本的结果，以下配置都是正常的：

1. ✅ **数据库菜单配置正常**
   - 生产管理(5042)下有7个菜单
   - 6个目录菜单（基础数据、生产计划、生产执行、质量管理、成本管理、统计分析）
   - 25个子菜单

2. ✅ **角色权限配置正常**
   - 已有5个角色分配了菜单权限

3. ✅ **前端文件完整**
   - 所有关键前端文件都存在

4. ✅ **服务运行正常**
   - 后端服务运行中（端口 48080）
   - 前端服务运行中（端口 5173）

## 🔍 问题原因

最可能的原因是：**前端缓存了旧的菜单数据**

前端菜单数据存储在浏览器的 Local Storage 中，键名为 `ROLE_ROUTERS`。如果菜单数据更新后没有清除缓存，前端会继续使用旧的菜单数据。

## 🛠️ 解决方案

### 方案1：清除浏览器缓存（推荐）

#### 方法A：使用浏览器开发者工具

1. 打开浏览器开发者工具（按 `F12` 或 `Cmd+Option+I`）
2. 进入 **Application** 标签（Chrome）或 **存储** 标签（Firefox）
3. 在左侧找到 **Local Storage**
4. 选择你的网站域名（如 `http://localhost:5173`）
5. 找到并删除以下键：
   - `ROLE_ROUTERS`
   - `USER`
   - 或者直接点击 **Clear All** 清除所有缓存
6. 刷新页面并重新登录

#### 方法B：使用浏览器设置

1. 打开浏览器设置
2. 进入隐私/清除浏览数据
3. 选择清除 **缓存** 和 **Cookie**
4. 刷新页面并重新登录

### 方案2：检查角色权限

1. 登录系统管理后台
2. 进入：**系统管理** → **角色管理**
3. 编辑你当前使用的角色（通常是"超级管理员"或"普通角色"）
4. 在 **菜单权限** 中，确认以下菜单已勾选：
   - ✅ 生产管理 (5042)
   - ✅ 基础数据 (6100)
   - ✅ 生产计划 (6101)
   - ✅ 生产执行 (6102)
   - ✅ 质量管理 (6103)
   - ✅ 成本管理 (6104)
   - ✅ 统计分析 (6105)
   - ✅ 以及所有子菜单
5. 点击 **保存**
6. **重新登录**系统

### 方案3：检查菜单状态

1. 登录系统管理后台
2. 进入：**系统管理** → **菜单管理**
3. 搜索新菜单（如"基础数据"、"生产计划"等）
4. 确认以下设置：
   - ✅ **状态**：启用
   - ✅ **可见**：是
   - ✅ **排序**：已设置
5. 如果有菜单被禁用，点击 **启用**

### 方案4：重启服务

如果以上方法都不行，尝试重启服务：

```bash
# 1. 重启后端服务
cd /Users/xierui/Documents/Project/Other/erp-system
./scripts/dev/start-backend.sh -d

# 2. 重启前端服务
cd original-yudao-ui
pnpm dev
```

## 🔧 技术细节

### 菜单数据流程

1. **用户登录** → 调用 `/admin-api/system/auth/get-permission-info` API
2. **后端返回** → 包含用户信息和菜单树（`menus` 字段）
3. **前端存储** → 菜单数据存储在 `wsCache` 中，键名 `ROLE_ROUTERS`
4. **路由生成** → 从缓存读取菜单数据，动态生成路由

### 缓存键名

前端使用以下缓存键：
- `ROLE_ROUTERS`：角色路由（菜单数据）
- `USER`：用户信息

### 清除缓存的代码位置

如果需要通过代码清除缓存，可以在浏览器控制台执行：

```javascript
// 清除菜单缓存
localStorage.removeItem('ROLE_ROUTERS')
// 或者清除所有缓存
localStorage.clear()
// 然后刷新页面
location.reload()
```

## 📊 菜单结构

当前菜单结构：

```
生产管理 (5042)
├── 基础数据 (6100)
│   ├── 产品BOM (5050)
│   ├── BOM明细 (5051)
│   ├── 工艺路线 (5052)
│   ├── 工艺路线明细 (5053)
│   ├── 设备列表 (5064)
│   ├── 设备状态 (5065)
│   └── 工序管理 (6006)
├── 生产计划 (6101)
│   ├── 生产订单 (5043)
│   ├── MRP参数 (5056)
│   ├── MRP运算结果 (5057)
│   ├── 生产排程 (5054)
│   └── 排程明细 (5055)
├── 生产执行 (6102)
│   ├── 工单 (5058)
│   └── 工单进度 (5059)
├── 质量管理 (6103)
│   ├── 质检标准 (5060)
│   ├── 质检项目 (5061)
│   ├── 质检记录 (5062)
│   └── 质检明细 (5063)
├── 成本管理 (6104)
│   ├── 标准成本 (5066)
│   ├── 实际成本 (5067)
│   └── 成本差异 (5068)
└── 统计分析 (6105)
    ├── 工时统计 (5069)
    ├── 生产KPI (5070)
    ├── 生产报表 (5071)
    └── 看板配置 (5072)
```

## ✅ 验证步骤

修复后，请验证：

1. ✅ 重新登录系统
2. ✅ 在左侧菜单中能看到 **生产管理** 菜单
3. ✅ 展开后能看到 6 个目录菜单
4. ✅ 每个目录下都有对应的子菜单
5. ✅ 点击菜单能正常跳转到对应页面

## 🆘 如果问题仍然存在

如果按照以上步骤操作后问题仍然存在，请检查：

1. **后端日志**：查看 `nohup.out` 或后端控制台，确认API是否正常返回菜单数据
2. **浏览器控制台**：查看是否有JavaScript错误
3. **网络请求**：在开发者工具的Network标签中，查看 `/admin-api/system/auth/get-permission-info` 的响应，确认是否包含新菜单
4. **数据库**：确认菜单的 `status` 字段为 `0`（启用），`visible` 字段为 `1`（可见）

## 📝 相关文件

- 检查脚本：`scripts/check-menu-config.sh`
- 前端路由配置：`original-yudao-ui/src/utils/routerHelper.ts`
- 权限存储：`original-yudao-ui/src/store/modules/permission.ts`
- 用户信息存储：`original-yudao-ui/src/store/modules/user.ts`

