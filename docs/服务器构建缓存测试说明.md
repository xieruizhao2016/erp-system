# æœåŠ¡å™¨æ„å»ºç¼“å­˜æµ‹è¯•è¯´æ˜

## âš ï¸ å½“å‰çŠ¶æ€

ç”±äºæœåŠ¡å™¨ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•ä» Docker Hub æ‹‰å–åŸºç¡€é•œåƒï¼ˆ`node:18-alpine`ï¼‰ï¼Œå¯¼è‡´æ„å»ºå¤±è´¥ã€‚

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šé…ç½® Docker é•œåƒæºï¼ˆæ¨èï¼‰

æœåŠ¡å™¨ä¸Šçš„ Docker é•œåƒæºå·²é…ç½®ï¼Œä½†å¯èƒ½éœ€è¦é‡å¯ Docker æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo systemctl restart docker

# æˆ–è€…ä½¿ç”¨ sudo -i åˆ‡æ¢åˆ° root
sudo -i
systemctl restart docker
exit
```

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨æ‹‰å–é•œåƒ

```bash
# å°è¯•ä½¿ç”¨é•œåƒæºæ‹‰å–
docker pull docker.mirrors.ustc.edu.cn/library/node:18-alpine

# æˆ–è€…ä½¿ç”¨å…¶ä»–é•œåƒæº
docker pull hub-mirror.c.163.com/library/node:18-alpine
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ç°æœ‰é•œåƒï¼ˆå¦‚æœå¯ç”¨ï¼‰

å¦‚æœæœåŠ¡å™¨ä¸Šå·²æœ‰ `node:18-alpine` é•œåƒï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°é•œåƒ
docker images | grep node

# å¦‚æœæœ‰ï¼Œæ„å»ºæ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨
```

## ğŸ“‹ å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆç½‘ç»œæ­£å¸¸æ—¶ï¼‰

### æ­¥éª¤1ï¼šé¦–æ¬¡æ„å»ºï¼ˆå»ºç«‹ç¼“å­˜ï¼‰

```bash
cd /opt/erp-system/script/docker

# è®°å½•å¼€å§‹æ—¶é—´
START=$(date +%s)
docker-compose -f docker-compose.prod.yml --env-file .env build admin
END=$(date +%s)
echo "é¦–æ¬¡æ„å»ºè€—æ—¶: $((END - START)) ç§’"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Step 5/31 : RUN pnpm install --frozen-lockfile
 ---> Running in abc123...
ï¼ˆå®‰è£…ä¾èµ–ï¼Œè€—æ—¶ 3-5 åˆ†é’Ÿï¼‰
```

### æ­¥éª¤2ï¼šä¿®æ”¹ä»£ç ï¼ˆæ¨¡æ‹Ÿä»£ç å˜æ›´ï¼‰

```bash
# ä¿®æ”¹ä»»æ„ä¸€ä¸ªå‰ç«¯æ–‡ä»¶
cd /opt/erp-system/original-yudao-ui
echo "// Test change $(date)" >> src/main.ts
```

### æ­¥éª¤3ï¼šç¬¬äºŒæ¬¡æ„å»ºï¼ˆæµ‹è¯•ç¼“å­˜ï¼‰

```bash
cd /opt/erp-system/script/docker

# è®°å½•å¼€å§‹æ—¶é—´
START=$(date +%s)
docker-compose -f docker-compose.prod.yml --env-file .env build admin
END=$(date +%s)
echo "ç¬¬äºŒæ¬¡æ„å»ºè€—æ—¶: $((END - START)) ç§’"
```

**é¢„æœŸè¾“å‡ºï¼ˆç¼“å­˜ç”Ÿæ•ˆï¼‰**ï¼š
```
Step 5/31 : RUN pnpm install --frozen-lockfile
 ---> Using cache
 ---> abc123def456
ï¼ˆè·³è¿‡ä¾èµ–å®‰è£…ï¼Œç›´æ¥æ„å»ºï¼Œè€—æ—¶ 2-3 åˆ†é’Ÿï¼‰
```

### æ­¥éª¤4ï¼šå¯¹æ¯”ç»“æœ

```bash
# æŸ¥çœ‹æ„å»ºå†å²
docker history yudao-admin:latest --format "table {{.CreatedBy}}\t{{.Size}}" | head -15
```

**ç¼“å­˜ç”Ÿæ•ˆçš„æ ‡å¿—**ï¼š
- ä¾èµ–å®‰è£…å±‚æ˜¾ç¤º `Using cache`
- ç¬¬äºŒæ¬¡æ„å»ºæ—¶é—´æ˜æ˜¾å‡å°‘ï¼ˆè‡³å°‘ 50%ï¼‰

## ğŸ¯ éªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ

### æ–¹æ³•1ï¼šæŸ¥çœ‹æ„å»ºè¾“å‡º

```bash
docker-compose build admin 2>&1 | grep -E "(CACHED|Using cache)"
```

å¦‚æœçœ‹åˆ° `Using cache`ï¼Œè¯´æ˜ç¼“å­˜ç”Ÿæ•ˆã€‚

### æ–¹æ³•2ï¼šæŸ¥çœ‹æ„å»ºæ—¶é—´

```bash
# é¦–æ¬¡æ„å»º
time docker-compose build admin
# è¾“å‡º: real 5m30s

# ç¬¬äºŒæ¬¡æ„å»ºï¼ˆåªä¿®æ”¹ä»£ç ï¼‰
time docker-compose build admin  
# è¾“å‡º: real 2m15s  â† æ—¶é—´æ˜æ˜¾å‡å°‘
```

### æ–¹æ³•3ï¼šæŸ¥çœ‹ Docker å±‚

```bash
docker history yudao-admin:latest --format "table {{.ID}}\t{{.CreatedBy}}\t{{.Size}}"
```

å¦‚æœå¤šä¸ªå±‚çš„ ID ç›¸åŒï¼Œè¯´æ˜ä½¿ç”¨äº†ç¼“å­˜ã€‚

## ğŸ“Š é¢„æœŸæ•ˆæœ

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœæ—¶é—´ |
|------|--------|--------|----------|
| åªä¿®æ”¹ä»£ç  | 5-8åˆ†é’Ÿ | 2-3åˆ†é’Ÿ | **60%+** |
| ä¿®æ”¹ä¾èµ– | 5-8åˆ†é’Ÿ | 5-8åˆ†é’Ÿ | 0% |

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ„å»ºå¤±è´¥ - æ— æ³•æ‹‰å–é•œåƒ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
failed to solve: node:18-alpine: failed to resolve source metadata
```

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š`ping registry-1.docker.io`
2. é‡å¯ Docker æœåŠ¡ï¼š`sudo systemctl restart docker`
3. ä½¿ç”¨é•œåƒæºï¼šé…ç½® `/etc/docker/daemon.json`

### é—®é¢˜2ï¼šç¼“å­˜æœªç”Ÿæ•ˆ

**å¯èƒ½åŸå› **ï¼š
- Dockerfile å±‚é¡ºåºä¸å¯¹
- ä¿®æ”¹äº†ä¸åº”è¯¥ä¿®æ”¹çš„æ–‡ä»¶
- Docker ç¼“å­˜è¢«æ¸…ç†

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ Dockerfile
cat /opt/erp-system/original-yudao-ui/Dockerfile

# ç¡®ä¿é¡ºåºæ­£ç¡®ï¼š
# 1. COPY package.json pnpm-lock.yaml ./
# 2. RUN pnpm install
# 3. COPY . .
```

### é—®é¢˜3ï¼šæ„å»ºæ—¶é—´æ²¡æœ‰æ˜æ˜¾å‡å°‘

**å¯èƒ½åŸå› **ï¼š
- ä»£ç æ„å»ºæœ¬èº«å¾ˆæ…¢
- ç½‘ç»œé—®é¢˜å¯¼è‡´ä¸‹è½½æ…¢
- æœºå™¨æ€§èƒ½é™åˆ¶

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥æ„å»ºæ—¥å¿—ï¼Œæ‰¾å‡ºæœ€æ…¢çš„æ­¥éª¤
- ä¼˜åŒ–æ„å»ºé…ç½®
- ä½¿ç”¨æ›´å¿«çš„æœºå™¨

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] Docker æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] å¯ä»¥æ‹‰å–åŸºç¡€é•œåƒï¼ˆnode:18-alpineï¼‰
- [ ] é¦–æ¬¡æ„å»ºæˆåŠŸ
- [ ] ç¬¬äºŒæ¬¡æ„å»ºæ—¶ä¾èµ–å®‰è£…å±‚æ˜¾ç¤º `Using cache`
- [ ] æ„å»ºæ—¶é—´æ˜æ˜¾å‡å°‘ï¼ˆè‡³å°‘ 50%ï¼‰
- [ ] æ„å»ºäº§ç‰©æ­£å¸¸ï¼ˆå¯ä»¥å¯åŠ¨å®¹å™¨æµ‹è¯•ï¼‰

## ğŸš€ å¿«é€Ÿæµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•è„šæœ¬ `/opt/erp-system/test-cache.sh`ï¼š

```bash
#!/bin/bash
cd /opt/erp-system/script/docker

echo "=== é¦–æ¬¡æ„å»º ==="
time docker-compose -f docker-compose.prod.yml --env-file .env build admin

echo ""
echo "=== ä¿®æ”¹ä»£ç  ==="
echo "// test" >> /opt/erp-system/original-yudao-ui/src/main.ts

echo ""
echo "=== ç¬¬äºŒæ¬¡æ„å»ºï¼ˆæµ‹è¯•ç¼“å­˜ï¼‰==="
time docker-compose -f docker-compose.prod.yml --env-file .env build admin
```

æ‰§è¡Œï¼š
```bash
chmod +x /opt/erp-system/test-cache.sh
/opt/erp-system/test-cache.sh
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯æ„å»ºä¼˜åŒ–è¯´æ˜](./å‰ç«¯æ„å»ºä¼˜åŒ–è¯´æ˜.md)
- [æ„å»ºç¼“å­˜æµ‹è¯•æŒ‡å—](./æ„å»ºç¼“å­˜æµ‹è¯•æŒ‡å—.md)
- [Docker æ„å»ºç¼“å­˜æœ€ä½³å®è·µ](https://docs.docker.com/build/cache/)

