# 销售订单新增字段说明

## 📋 概述

本次更新为销售管理-销售订单模块新增了两个字段：

1. **采购单号** - 用于记录关联的采购单号（可选）
2. **合同编号** - 用于记录关联的合同编号（可选）

## 🔧 修改文件清单

### 1. 数据库相关

#### 1.1 表结构更新
**文件路径**: `/sql/mysql/erp-tables.sql`

在 `erp_sale_order` 表中新增两个字段：
```sql
`purchase_order_no` varchar(100) NULL DEFAULT '' COMMENT '采购单号'
`contract_no` varchar(100) NULL DEFAULT '' COMMENT '合同编号'
```

#### 1.2 数据库迁移脚本
**文件路径**: `/sql/mysql/erp_sale_order_add_fields_migration.sql`

为现有数据库添加新字段的迁移脚本，可直接执行：
```bash
mysql -u root -p erp_database < sql/mysql/erp_sale_order_add_fields_migration.sql
```

### 2. 后端代码修改

#### 2.1 实体类 (DO)
**文件路径**: `/yudao-module-erp/src/main/java/cn/iocoder/yudao/module/erp/dal/dataobject/sale/ErpSaleOrderDO.java`

新增字段：
```java
private String purchaseOrderNo; // 采购单号
private String contractNo;      // 合同编号
```

#### 2.2 请求VO
**文件路径**: `/yudao-module-erp/src/main/java/cn/iocoder/yudao/module/erp/controller/admin/sale/vo/order/ErpSaleOrderSaveReqVO.java`

新增字段及Swagger注解：
```java
@Schema(description = "采购单号", example = "PO202511210001")
private String purchaseOrderNo;

@Schema(description = "合同编号", example = "HT202511210001")
private String contractNo;
```

#### 2.3 响应VO
**文件路径**: `/yudao-module-erp/src/main/java/cn/iocoder/yudao/module/erp/controller/admin/sale/vo/order/ErpSaleOrderRespVO.java`

新增字段及Excel导出注解：
```java
@Schema(description = "采购单号", example = "PO202511210001")
@ExcelProperty("采购单号")
private String purchaseOrderNo;

@Schema(description = "合同编号", example = "HT202511210001")
@ExcelProperty("合同编号")
private String contractNo;
```

### 3. 前端代码修改

#### 3.1 API类型定义
**文件路径**: `/original-yudao-ui/src/api/erp/sale/order/index.ts`

在 `SaleOrderVO` 接口中新增字段：
```typescript
purchaseOrderNo: string // 采购单号
contractNo: string      // 合同编号
```

#### 3.2 表单页面
**文件路径**: `/original-yudao-ui/src/views/erp/sale/order/SaleOrderForm.vue`

新增表单项（位于销售人员之后）：

1. **采购单号** - 文本输入框
```vue
<el-form-item label="采购单号" prop="purchaseOrderNo">
  <el-input v-model="formData.purchaseOrderNo" placeholder="请输入采购单号" />
</el-form-item>
```

2. **合同编号** - 文本输入框
```vue
<el-form-item label="合同编号" prop="contractNo">
  <el-input v-model="formData.contractNo" placeholder="请输入合同编号" />
</el-form-item>
```

同时更新了 `formData` 初始化和 `resetForm` 函数，添加了新字段的默认值。

## 📦 部署步骤

### 1. 数据库更新

```bash
# 执行迁移脚本，添加新字段
mysql -u root -p erp_database < sql/mysql/erp_sale_order_add_fields_migration.sql
```

### 2. 后端部署

```bash
# 重新编译后端代码
cd yudao-module-erp
mvn clean install

# 重启后端服务
./start-backend.sh
```

### 3. 前端部署

```bash
# 进入前端目录
cd original-yudao-ui

# 重新构建前端
npm run build:prod

# 重启前端服务（如果使用nginx，需要更新静态文件）
```

## ✅ 功能验证

### 1. 功能测试

1. 登录系统，进入 **销售管理 > 销售订单**
2. 点击 **新增** 按钮
3. 验证以下功能：
   - 采购单号输入框正常显示和输入（可选字段）
   - 合同编号输入框正常显示和输入（可选字段）
4. 填写完整信息后点击 **确定**
5. 在列表页查看新增的销售订单
6. 点击 **编辑** 按钮，验证新字段可以正常回显和修改
7. 点击 **详情** 按钮，验证新字段可以正常展示

### 2. 数据验证

直接查询数据库验证：
```sql
SELECT id, no, purchase_order_no, contract_no, customer_id, status 
FROM erp_sale_order 
WHERE deleted = 0 
ORDER BY id DESC 
LIMIT 10;
```

### 3. Excel导出验证

1. 在销售订单列表页点击 **导出** 按钮
2. 下载Excel文件
3. 验证Excel中包含新增的两个字段列："采购单号"和"合同编号"

## 🎨 界面效果

在销售订单新增/编辑表单中，新字段的布局为：

```
第一行：
| 订单单号            | 订单时间          | 客户              |

第二行：
| 销售人员            | 采购单号          | 合同编号          |

第三行：
| 备注                                    | 附件              |
```

## 📝 注意事项

1. **数据迁移**：执行迁移脚本前，建议先备份数据库
2. **字段验证**：新增的两个字段均为**可选字段**（非必填），不影响现有数据和业务流程
3. **字段长度**：两个字段长度均为100个字符，如有特殊需求可以调整
4. **权限配置**：确保用户有销售订单的新增和编辑权限

## 🔄 后续优化建议

1. **采购单号联动**：可以考虑与采购订单模块联动，提供下拉选择功能
   ```vue
   <el-select v-model="formData.purchaseOrderNo" filterable placeholder="请选择或输入采购单号">
     <el-option
       v-for="item in purchaseOrderList"
       :key="item.no"
       :label="item.no"
       :value="item.no"
     />
   </el-select>
   ```

2. **合同管理集成**：如果系统有合同管理模块，可以实现合同编号的关联选择

3. **字段验证**：根据业务需求添加字段格式验证（如正则表达式验证单号格式）

4. **业务关联**：可以基于这两个字段实现：
   - 按采购单号查询销售订单
   - 按合同编号统计销售数据
   - 采购-销售关联分析报表

## 📊 数据统计

新增字段可用于以下业务场景：

1. **采购-销售追溯**：通过采购单号追踪从采购到销售的完整链路
2. **合同执行情况**：通过合同编号统计合同执行进度和金额
3. **订单关联分析**：分析采购订单与销售订单的对应关系
4. **财务核对**：便于财务部门核对采购成本与销售收入

## 📞 技术支持

如有问题，请联系技术支持团队。

---
**更新时间**: 2025年11月21日  
**版本**: v1.0  
**关联需求**: 销售订单新增采购单号和合同编号字段

