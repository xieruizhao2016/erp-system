# 新功能开发进度

**更新时间**: 2025-12-09  
**当前阶段**: Phase 2 - 代码生成

---

## ✅ Phase 1: 数据库表创建（已完成）

### 已创建的SQL脚本

1. **财务模块表** (`sql/mysql/erp-finance-tables.sql`)
   - ✅ `erp_finance_balance_sheet` - 资产负债表
   - ✅ `erp_finance_receivable` - 应收账款
   - ✅ `erp_finance_payable` - 应付账款
   - ✅ `erp_finance_prepayment` - 预付款
   - ✅ `erp_finance_prereceipt` - 预收款
   - ✅ `erp_finance_profit_statement` - 利润表

2. **内部出入库表** (`sql/mysql/erp-stock-internal-tables.sql`)
   - ✅ `erp_stock_internal_in` - 内部入库单
   - ✅ `erp_stock_internal_in_item` - 内部入库明细
   - ✅ `erp_stock_internal_out` - 内部出库单
   - ✅ `erp_stock_internal_out_item` - 内部出库明细

3. **销售订单字段扩展** (`sql/mysql/erp-sale-order-gross-profit-fields.sql`)
   - ✅ `erp_sale_order` 表添加毛利率相关字段
   - ✅ `erp_sale_order_items` 表添加毛利率相关字段

### 已创建的枚举类

1. **ErpInternalType.java** - 内部流转类型枚举
   - ✅ DEPT_TRANSFER(1, "部门调拨")
   - ✅ EMPLOYEE_USE(2, "员工领用")
   - ✅ OTHER(3, "其他")

2. **ErpStockRecordBizTypeEnum.java** - 扩展库存记录业务类型
   - ✅ INTERNAL_IN(90, "内部入库")
   - ✅ INTERNAL_IN_CANCEL(91, "内部入库（作废）")
   - ✅ INTERNAL_OUT(92, "内部出库")
   - ✅ INTERNAL_OUT_CANCEL(93, "内部出库（作废）")

### 辅助脚本

1. **execute-new-features-sql.sh** - 执行SQL脚本
2. **generate-new-features-code.sh** - 批量代码生成脚本

---

## 🔄 Phase 2: 代码生成（进行中）

### 步骤1: 执行SQL脚本创建表

```bash
# 方法1: 使用辅助脚本（推荐）
./scripts/execute-new-features-sql.sh

# 方法2: 手动执行
mysql -uroot -p123456 ruoyi-vue-pro < sql/mysql/erp-finance-tables.sql
mysql -uroot -p123456 ruoyi-vue-pro < sql/mysql/erp-stock-internal-tables.sql
mysql -uroot -p123456 ruoyi-vue-pro < sql/mysql/erp-sale-order-gross-profit-fields.sql
```

### 步骤2: 获取JWT Token

```bash
./scripts/get-jwt-token.sh admin admin123 http://localhost:48080/admin-api 1
```

### 步骤3: 使用代码生成器生成代码

```bash
# 使用批量生成脚本（推荐）
./scripts/generate-new-features-code.sh

# 或使用单个表生成
./scripts/use-codegen-api.sh create-table erp_finance_balance_sheet
./scripts/use-codegen-api.sh create-table erp_finance_receivable
# ... 其他表
```

### 步骤4: 配置代码生成选项

需要为每张表配置以下选项（通过前端界面或API）：

#### 财务模块表配置

| 表名 | 模块名 | 业务名 | 类名 | 类描述 |
|------|--------|--------|------|--------|
| erp_finance_balance_sheet | erp | finance-balance-sheet | ErpFinanceBalanceSheet | 资产负债表 |
| erp_finance_receivable | erp | finance-receivable | ErpFinanceReceivable | 应收账款 |
| erp_finance_payable | erp | finance-payable | ErpFinancePayable | 应付账款 |
| erp_finance_prepayment | erp | finance-prepayment | ErpFinancePrepayment | 预付款 |
| erp_finance_prereceipt | erp | finance-prereceipt | ErpFinancePrereceipt | 预收款 |
| erp_finance_profit_statement | erp | finance-profit-statement | ErpFinanceProfitStatement | 利润表 |

#### 内部出入库表配置

| 表名 | 模块名 | 业务名 | 类名 | 类描述 |
|------|--------|--------|------|--------|
| erp_stock_internal_in | erp | stock-internal-in | ErpStockInternalIn | 内部入库单 |
| erp_stock_internal_out | erp | stock-internal-out | ErpStockInternalOut | 内部出库单 |

**字段配置要点**:
- `customer_id`, `supplier_id`, `order_id`: 列表显示，表单显示，查询，关联查询
- `amount`, `balance`, `received_amount`等金额字段: 列表显示，表单显示，查询
- `status`: 列表显示，表单显示，查询，使用枚举选择器
- `period_date`, `due_date`等日期字段: 列表显示，表单显示，查询，使用日期选择器
- `employee_id`, `dept_id`: 列表显示，表单显示，查询，使用选择器组件
- `internal_type`: 列表显示，表单显示，查询，使用枚举选择器

### 步骤5: 下载生成的代码

```bash
# 使用批量脚本会自动下载
# 或手动下载
./scripts/use-codegen-api.sh download <TABLE_ID>
```

### 步骤6: 部署生成的代码

1. 解压代码包
2. 复制后端代码到 `yudao-module-erp`
3. 复制前端代码到 `original-yudao-ui`
4. 合并ErrorCode（手动合并，不要覆盖）
5. 修复编译错误

---

## 📋 Phase 3: 业务逻辑开发（待开始）

### 3.1 财务模块业务逻辑

- [ ] 应收账款自动生成（销售订单审核通过后）
- [ ] 应收账款核销（收款单审核通过后）
- [ ] 应付账款自动生成（采购订单审核通过后）
- [ ] 应付账款核销（付款单审核通过后）
- [ ] 预付款/预收款逻辑
- [ ] 资产负债表自动计算
- [ ] 利润表自动计算

### 3.2 内部出入库业务逻辑

- [ ] 参考现有出入库实现
- [ ] 实现创建、审核、库存更新逻辑
- [ ] 员工和部门关联
- [ ] 库存记录创建逻辑

### 3.3 销售订单毛利率计算

- [ ] 原材料成本计算（从BOM获取）
- [ ] 员工成本计算（从工艺路线获取）
- [ ] 毛利率计算
- [ ] 集成到订单保存流程

---

## 📋 Phase 4: 前端优化（待开始）

- [ ] 财务模块前端优化
- [ ] 内部出入库前端优化
- [ ] 销售订单前端优化（添加毛利率列、筛选、排序）

---

## 📋 Phase 5: 测试和优化（待开始）

- [ ] 功能测试
- [ ] 性能优化
- [ ] Bug修复

---

## 📁 关键文件路径

### SQL脚本
- `sql/mysql/erp-finance-tables.sql`
- `sql/mysql/erp-stock-internal-tables.sql`
- `sql/mysql/erp-sale-order-gross-profit-fields.sql`

### 枚举类
- `yudao-module-erp/src/main/java/cn/iocoder/yudao/module/erp/enums/ErpInternalType.java`
- `yudao-module-erp/src/main/java/cn/iocoder/yudao/module/erp/enums/stock/ErpStockRecordBizTypeEnum.java`

### 辅助脚本
- `scripts/execute-new-features-sql.sh`
- `scripts/generate-new-features-code.sh`

---

## ⚠️ 注意事项

1. **执行SQL脚本前**，确保MySQL服务运行且数据库已创建
2. **代码生成前**，确保后端服务运行并可访问
3. **部署代码时**，注意合并ErrorCode，不要直接覆盖
4. **明细表处理**：内部出入库的明细表作为子表处理，不需要单独生成代码

---

## 🔗 相关文档

- [新功能开发计划.md](./新功能开发计划.md) - 完整开发计划
- [代码生成器使用指南.md](./代码生成器使用指南.md) - 代码生成器详细说明

