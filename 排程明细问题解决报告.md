# 排程明细"服务器错误"问题解决报告

## 📋 问题描述

访问【生产管理】-【排程明细】页面时，提示："服务器错误，请联系管理员"

## 🔍 问题诊断

### 日志分析结果

**后端日志 (`backend.log`)**：
```
Unable to connect to Redis server: 127.0.0.1/127.0.0.1:6380
```

**根本原因**：
1. 后端服务启动时Redis服务未就绪
2. 导致Spring Boot应用启动失败
3. 前端访问API时后端服务无响应，显示"服务器错误"

### 当前状态检查

执行以下诊断后确认：

✅ **Redis服务**：正常运行（端口6380，PONG响应）
```bash
$ redis-cli -p 6380 ping
PONG
```

✅ **后端服务**：正常运行（端口48080）
```bash
$ curl http://localhost:48080/admin-api/system/auth/get-permission-info
{"code":401,"msg":"账号未登录","data":null}
```

✅ **排程明细API**：已正确注册
```bash
$ curl http://localhost:48080/admin-api/erp/production-schedule-item/page?pageNo=1&pageSize=10
{"code":401,"msg":"账号未登录","data":null}
```

> **说明**：返回401表示API存在且正常，只是需要登录验证

## ✅ 解决方案

### 方案一：使用一键修复脚本（推荐）

```bash
# 1. 执行一键修复脚本
chmod +x 一键修复排程明细.sh
./一键修复排程明细.sh

# 2. 按提示输入MySQL密码

# 3. 等待脚本执行完成
```

脚本会自动执行：
- ✓ 创建排程明细数据表
- ✓ 配置字典数据（状态值）
- ✓ 配置菜单和权限
- ✓ 给超级管理员分配权限

### 方案二：手动执行SQL

如果你更喜欢手动操作：

```bash
# 进入项目SQL目录
cd /Users/xierui/Documents/Project/erp-system/sql/mysql

# 执行以下SQL文件（按顺序）
mysql -uroot -p your_database << EOF
-- 1. 创建数据表
source erp-production-tables.sql

-- 2. 配置字典
source erp_production_dict_import.sql

-- 3. 配置菜单
source erp_production_menus_final.sql
EOF
```

### 方案三：检查服务状态

如果问题仍然存在，可能是服务未正确启动：

```bash
# 1. 确保Redis正在运行
redis-cli -p 6380 ping
# 应该返回：PONG

# 2. 重启后端服务
cd /Users/xierui/Documents/Project/erp-system
./start-backend.sh

# 3. 查看启动日志，确保没有错误
tail -f backend.log
```

## 🌐 前端操作

完成数据库修复后，需要：

### 1. 清除浏览器缓存

**Chrome/Edge**：
- 按 `Ctrl + Shift + Delete` (Windows) 或 `Cmd + Shift + Delete` (Mac)
- 选择"缓存的图片和文件"
- 点击"清除数据"

**或者使用无痕模式**：
- Chrome/Edge: `Ctrl + Shift + N` (Windows) 或 `Cmd + Shift + N` (Mac)
- Firefox: `Ctrl + Shift + P`

### 2. 重新登录系统

1. 完全退出系统（不只是关闭标签页）
2. 重新打开浏览器
3. 访问系统登录页面
4. 使用管理员账号登录

### 3. 验证功能

1. 登录后进入【系统管理】-【菜单管理】
2. 搜索"排程明细"，确认菜单存在
3. 进入【系统管理】-【角色管理】
4. 编辑你的角色，确认勾选了"排程明细"相关权限
5. 访问【生产管理】-【排程明细】页面

## 🧪 测试脚本

使用以下脚本测试API是否正常：

```bash
# 运行API测试脚本
chmod +x test-schedule-item-api.sh
./test-schedule-item-api.sh
```

## 📝 预防措施

为避免类似问题再次发生：

### 1. 服务启动顺序

确保按以下顺序启动服务：

```bash
# 1. 先启动MySQL
sudo systemctl start mysql  # 或 brew services start mysql

# 2. 再启动Redis
redis-server /path/to/redis.conf  # 或 brew services start redis

# 3. 最后启动后端服务
./start-backend.sh

# 4. 启动前端服务
cd original-yudao-ui && npm run dev
```

### 2. 健康检查脚本

创建服务健康检查脚本：

```bash
#!/bin/bash
# health-check.sh

echo "检查服务状态..."

# 检查MySQL
mysql -uroot -p -e "SELECT 1" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ MySQL 正常"
else
    echo "✗ MySQL 异常"
fi

# 检查Redis
redis-cli -p 6380 ping > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ Redis 正常"
else
    echo "✗ Redis 异常"
fi

# 检查后端服务
curl -s http://localhost:48080/admin-api/system/auth/get-permission-info > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ 后端服务正常"
else
    echo "✗ 后端服务异常"
fi

# 检查前端服务
curl -s http://localhost:80 > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ 前端服务正常"
else
    echo "✗ 前端服务异常"
fi
```

### 3. 配置服务自动启动

**Redis 开机自启动（Mac）**：
```bash
brew services start redis
```

**MySQL 开机自启动（Mac）**：
```bash
brew services start mysql
```

## 🔧 常见问题

### Q1: 执行修复脚本后还是报错？

**A**: 尝试以下步骤：
1. 完全关闭浏览器（所有窗口）
2. 重启后端服务
3. 使用无痕模式访问
4. 检查浏览器控制台（F12）的Network标签，查看具体错误

### Q2: 菜单显示了但点击还是报错？

**A**: 可能是权限配置问题：
1. 进入【系统管理】-【角色管理】
2. 找到你的角色，点击"修改"
3. 在菜单权限树中勾选"排程明细"及其子权限
4. 保存后重新登录

### Q3: 其他页面正常，只有排程明细报错？

**A**: 可能是依赖的数据表不存在：
- 生产排程表 (`erp_production_schedule`)
- 生产订单表 (`erp_production_order`)
- 产品表 (`erp_product`)
- 设备表 (`erp_equipment`)

执行以下SQL检查：
```sql
SHOW TABLES LIKE 'erp_production%';
SHOW TABLES LIKE 'erp_product';
SHOW TABLES LIKE 'erp_equipment';
```

## 📊 问题追踪

| 时间 | 状态 | 说明 |
|------|------|------|
| 2025-11-03 14:54 | ❌ 后端启动失败 | Redis连接失败 |
| 当前 | ✅ Redis正常 | 服务已恢复 |
| 当前 | ✅ 后端正常 | API可访问 |
| 待确认 | ⏳ 前端访问 | 需要用户测试 |

## 📞 如果问题仍未解决

请提供以下信息：

1. **浏览器控制台错误**：
   - 按 F12 打开开发者工具
   - 切换到 Console 标签
   - 截图所有红色错误

2. **网络请求详情**：
   - 开发者工具 Network 标签
   - 点击排程明细菜单
   - 找到失败的请求
   - 截图 Response 内容

3. **后端最新日志**：
```bash
tail -100 backend.log
```

4. **数据库检查结果**：
```sql
-- 检查表是否存在
SELECT COUNT(*) FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = DATABASE() 
  AND TABLE_NAME = 'erp_production_schedule_item';

-- 检查菜单是否配置
SELECT * FROM system_menu WHERE name = '排程明细';
```

## ✨ 总结

**问题本质**：Redis服务启动顺序导致后端服务初始化失败

**解决要点**：
1. ✅ 确保服务启动顺序正确（MySQL → Redis → Backend → Frontend）
2. ✅ 执行数据库配置（表、字典、菜单、权限）
3. ✅ 清除浏览器缓存并重新登录
4. ✅ 验证权限配置

按照本文档的方案操作后，排程明细功能应该可以正常使用了！

