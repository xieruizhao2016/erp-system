# 数据库表关联字段检查报告

## 📋 检查说明

根据《生产管理系统完整使用流程.md》中定义的数据关联规则，检查ERP系统数据库表结构是否已添加必要的关联字段。

**检查时间**：2024年  
**检查范围**：生产管理系统相关的所有数据关联关系

---

## ✅ 已完成的关联字段

### 1. 生产订单表（erp_production_order）

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联客户 | `customer_id` | bigint | ✅ 已存在 | 客户ID（关联销售订单） |
| 关联产品 | `product_id` | bigint | ✅ 已存在 | 产品ID |
| 关联BOM | `bom_id` | bigint | ⚠️ 建议添加 | 关联BOM ID（记录使用的BOM版本） |
| 关联工艺路线 | `route_id` | bigint | ⚠️ 建议添加 | 关联工艺路线ID（记录使用的工艺路线版本） |
| 关联来源单据 | `source_id` | bigint | ✅ 已存在 | 来源单据ID（可关联销售订单） |
| 来源类型 | `source_type` | int | ✅ 已存在 | 1-手动创建，2-销售订单，3-库存补充 |

**说明**：
- 生产订单通过 `product_id` 可以间接关联BOM和工艺路线（BOM和工艺路线都关联产品ID）
- **建议**：添加 `bom_id` 和 `route_id` 字段，直接关联具体的BOM和工艺路线版本，便于：
  - 版本管理和追溯（即使BOM/工艺路线更新，也能追溯历史订单使用的版本）
  - 明确记录生产订单使用的具体BOM和工艺路线
  - 支持一个产品有多个BOM/工艺路线版本的情况
- 通过 `source_type=2` 和 `source_id` 可以关联销售订单

### 2. 采购订单表（erp_purchase_order）

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联生产订单 | `production_order_id` | bigint | ✅ 已添加 | 关联生产订单ID（当物料不足时创建采购订单） |

**SQL脚本位置**：`sql/mysql/erp-production-tables.sql` 第134-150行

### 3. 库存入库表（erp_stock_in）

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联生产订单 | `production_order_id` | bigint | ✅ 已添加 | 关联生产订单ID（用于成品/半成品入库） |

**SQL脚本位置**：`sql/mysql/erp-production-tables.sql` 第152-168行

### 4. 库存出库表（erp_stock_out）

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联生产订单 | `production_order_id` | bigint | ✅ 已添加 | 关联生产订单ID（用于原材料领料出库） |

**SQL脚本位置**：`sql/mysql/erp-production-tables.sql` 第170-186行

### 5. 销售订单表（erp_sale_order）

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 生产状态 | `production_status` | int | ✅ 已添加 | 生产状态：0-无需生产，1-生产中，2-生产完成 |

**SQL脚本位置**：`sql/mysql/erp-production-tables.sql` 第116-132行

---

## ⚠️ 缺失的关联字段

### 1. 生产订单表（erp_production_order）

**建议添加字段**：`bom_id`、`route_id`

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联BOM | `bom_id` | bigint | ⚠️ 建议添加 | 直接关联BOM ID（记录使用的BOM版本） |
| 关联工艺路线 | `route_id` | bigint | ⚠️ 建议添加 | 直接关联工艺路线ID（记录使用的工艺路线版本） |

**问题说明**：
- 当前生产订单只通过 `product_id` 间接关联BOM和工艺路线
- 一个产品可能有多个BOM版本和工艺路线版本
- 无法明确记录生产订单使用的具体BOM和工艺路线版本
- 如果后续BOM或工艺路线更新，无法追溯历史订单使用的版本

**建议**：
- 添加 `bom_id` 和 `route_id` 字段，直接关联具体的BOM和工艺路线
- 创建生产订单时，自动选择产品当前生效的BOM和工艺路线
- 支持版本管理和历史追溯

**SQL脚本位置**：`sql/mysql/erp-production-order-enhancement.sql`

### 2. 销售订单表（erp_sale_order）

**缺失字段**：`production_order_id`

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联生产订单 | `production_order_id` | bigint | ❌ 缺失 | 直接关联生产订单ID |

**问题说明**：
- 当前只有 `production_status` 字段表示生产状态
- 但无法直接关联到具体的生产订单
- 根据使用流程，销售订单应该可以关联生产订单

**建议**：
- 添加 `production_order_id` 字段，允许一个销售订单关联多个生产订单（或通过明细表关联）

**SQL脚本建议**：
```sql
-- 销售订单表扩展：production_order_id
ALTER TABLE `erp_sale_order` 
ADD COLUMN `production_order_id` bigint NULL COMMENT '关联生产订单ID' 
AFTER `production_status`;

-- 添加索引
ALTER TABLE `erp_sale_order` 
ADD INDEX `idx_production_order` (`production_order_id`) USING BTREE;
```

**注意**：如果销售订单可能关联多个生产订单，建议在销售订单明细表（`erp_sale_order_items`）中添加关联字段。

### 3. 收款单表（erp_finance_receipt）

**缺失字段**：`production_order_id`

| 关联关系 | 字段名 | 字段类型 | 状态 | 说明 |
|---------|--------|---------|------|------|
| 关联生产订单 | `production_order_id` | bigint | ❌ 缺失 | 关联生产订单ID |

**问题说明**：
- 收款单明细表（`erp_finance_receipt_item`）通过 `biz_type` 和 `biz_id` 关联业务单据
- 当前只能关联销售出库（`biz_type=21`），无法直接关联生产订单
- 根据使用流程，收款单应该关联销售订单和生产订单

**建议**：
- 方案1：在收款单主表添加 `production_order_id` 字段（如果收款单只关联一个生产订单）
- 方案2：在收款单明细表扩展 `biz_type`，增加生产订单类型，通过 `biz_id` 关联

**SQL脚本建议（方案1）**：
```sql
-- 收款单表扩展：production_order_id
ALTER TABLE `erp_finance_receipt` 
ADD COLUMN `production_order_id` bigint NULL COMMENT '关联生产订单ID' 
AFTER `customer_id`;

-- 添加索引
ALTER TABLE `erp_finance_receipt` 
ADD INDEX `idx_production_order` (`production_order_id`) USING BTREE;
```

**SQL脚本建议（方案2）**：
```sql
-- 在 ErpBizTypeEnum 枚举中增加生产订单类型
-- 例如：PRODUCTION_ORDER(30, "生产订单")
-- 然后在收款单明细表中通过 biz_type=30, biz_id=生产订单ID 来关联
```

---

## 📊 关联关系汇总表

### 直接关联关系

| 序号 | 关联关系 | 主表 | 关联字段 | 被关联表 | 状态 | 备注 |
|-----|---------|------|---------|---------|------|------|
| 1 | 生产订单 → 客户 | `erp_production_order` | `customer_id` | `erp_customer` | ✅ | 已存在 |
| 2 | 生产订单 → 产品 | `erp_production_order` | `product_id` | `erp_product` | ✅ | 已存在 |
| 3 | 生产订单 → 销售订单 | `erp_production_order` | `source_id` | `erp_sale_order` | ✅ | 通过source_type=2 |
| 4 | 生产订单 → BOM | `erp_production_order` | `product_id` | `erp_product_bom` | ✅ | 间接关联（通过产品） |
| 5 | 生产订单 → 工艺路线 | `erp_production_order` | `product_id` | `erp_process_route` | ✅ | 间接关联（通过产品） |
| 6 | 采购订单 → 生产订单 | `erp_purchase_order` | `production_order_id` | `erp_production_order` | ✅ | 已添加 |
| 7 | 库存入库 → 生产订单 | `erp_stock_in` | `production_order_id` | `erp_production_order` | ✅ | 已添加 |
| 8 | 库存出库 → 生产订单 | `erp_stock_out` | `production_order_id` | `erp_production_order` | ✅ | 已添加 |
| 9 | 销售订单 → 生产订单 | `erp_sale_order` | `production_order_id` | `erp_production_order` | ❌ | **缺失** |
| 10 | 收款单 → 生产订单 | `erp_finance_receipt` | `production_order_id` | `erp_production_order` | ❌ | **缺失** |
| 11 | 收款单 → 销售订单 | `erp_finance_receipt_item` | `biz_id` | `erp_sale_order` | ✅ | 通过biz_type关联 |
| 12 | 工单 → 生产订单 | `erp_work_order` | `production_order_id` | `erp_production_order` | ✅ | 已存在 |
| 13 | 排程明细 → 生产订单 | `erp_production_schedule_item` | `production_order_id` | `erp_production_order` | ✅ | 已存在 |
| 14 | 实际成本 → 生产订单 | `erp_cost_actual` | `production_order_id` | `erp_production_order` | ✅ | 已存在 |

### 间接关联关系（通过工单）

| 序号 | 关联关系 | 主表 | 关联字段 | 中间表 | 最终关联表 | 状态 | 备注 |
|-----|---------|------|---------|--------|-----------|------|------|
| 15 | 质检记录 → 生产订单 | `erp_quality_inspection` | `work_order_id` | `erp_work_order` | `erp_production_order` | ✅ | 通过工单间接关联 |
| 16 | 工单进度 → 生产订单 | `erp_work_order_progress` | `work_order_id` | `erp_work_order` | `erp_production_order` | ✅ | 通过工单间接关联 |
| 17 | 工时统计 → 生产订单 | `erp_work_hours` | `work_order_id` | `erp_work_order` | `erp_production_order` | ✅ | 通过工单间接关联 |
| 18 | 实际成本 → 生产订单 | `erp_cost_actual` | `work_order_id` | `erp_work_order` | `erp_production_order` | ✅ | 通过工单间接关联（同时有直接关联） |
| 19 | 设备状态 → 生产订单 | `erp_equipment_status` | `work_order_id` | `erp_work_order` | `erp_production_order` | ✅ | 通过工单间接关联 |

---

## 🔧 需要执行的SQL脚本

### 1. 生产订单表增强（添加BOM和工艺路线关联）

**脚本文件**：`sql/mysql/erp-production-order-enhancement.sql`

**功能**：
- 添加 `bom_id` 字段，关联BOM
- 添加 `route_id` 字段，关联工艺路线
- 自动创建索引

**执行顺序**：建议先执行此脚本，再执行其他补充脚本

### 2. 销售订单表添加生产订单关联字段

```sql
-- ============================================================
-- 销售订单表扩展：production_order_id
-- ============================================================
SET @dbname = DATABASE();
SET @tablename = 'erp_sale_order';
SET @columnname = 'production_order_id';
SET @preparedStatement = (SELECT IF(
    (
        SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
        WHERE
            (TABLE_SCHEMA = @dbname)
            AND (TABLE_NAME = @tablename)
            AND (COLUMN_NAME = @columnname)
    ) > 0,
    'SELECT 1',
    CONCAT('ALTER TABLE `', @tablename, '` ADD COLUMN `', @columnname, '` bigint NULL COMMENT ''关联生产订单ID'' AFTER `production_status`')
));
PREPARE alterIfNotExists FROM @preparedStatement;
EXECUTE alterIfNotExists;
DEALLOCATE PREPARE alterIfNotExists;

-- 添加索引
SET @indexname = 'idx_production_order';
SET @preparedStatement = (SELECT IF(
    (
        SELECT COUNT(*) FROM INFORMATION_SCHEMA.STATISTICS
        WHERE
            (TABLE_SCHEMA = @dbname)
            AND (TABLE_NAME = @tablename)
            AND (INDEX_NAME = @indexname)
    ) > 0,
    'SELECT 1',
    CONCAT('ALTER TABLE `', @tablename, '` ADD INDEX `', @indexname, '` (`', @columnname, '`) USING BTREE')
));
PREPARE alterIfNotExists FROM @preparedStatement;
EXECUTE alterIfNotExists;
DEALLOCATE PREPARE alterIfNotExists;
```

### 3. 收款单表添加生产订单关联字段

```sql
-- ============================================================
-- 收款单表扩展：production_order_id
-- ============================================================
SET @dbname = DATABASE();
SET @tablename = 'erp_finance_receipt';
SET @columnname = 'production_order_id';
SET @preparedStatement = (SELECT IF(
    (
        SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
        WHERE
            (TABLE_SCHEMA = @dbname)
            AND (TABLE_NAME = @tablename)
            AND (COLUMN_NAME = @columnname)
    ) > 0,
    'SELECT 1',
    CONCAT('ALTER TABLE `', @tablename, '` ADD COLUMN `', @columnname, '` bigint NULL COMMENT ''关联生产订单ID'' AFTER `customer_id`')
));
PREPARE alterIfNotExists FROM @preparedStatement;
EXECUTE alterIfNotExists;
DEALLOCATE PREPARE alterIfNotExists;

-- 添加索引
SET @indexname = 'idx_production_order';
SET @preparedStatement = (SELECT IF(
    (
        SELECT COUNT(*) FROM INFORMATION_SCHEMA.STATISTICS
        WHERE
            (TABLE_SCHEMA = @dbname)
            AND (TABLE_NAME = @tablename)
            AND (INDEX_NAME = @indexname)
    ) > 0,
    'SELECT 1',
    CONCAT('ALTER TABLE `', @tablename, '` ADD INDEX `', @indexname, '` (`', @columnname, '`) USING BTREE')
));
PREPARE alterIfNotExists FROM @preparedStatement;
EXECUTE alterIfNotExists;
DEALLOCATE PREPARE alterIfNotExists;
```

---

## 📝 检查结论

### ✅ 已完成（14项直接关联 + 5项间接关联）

#### 直接关联（14项）
1. ✅ 生产订单关联客户、产品、来源单据
2. ✅ 生产订单间接关联BOM和工艺路线（通过产品ID）
3. ✅ 采购订单关联生产订单
4. ✅ 库存入库关联生产订单
5. ✅ 库存出库关联生产订单
6. ✅ 工单关联生产订单
7. ✅ 排程明细关联生产订单
8. ✅ 实际成本关联生产订单
9. ✅ 销售订单有生产状态字段

#### 间接关联（5项，通过工单）
10. ✅ 质检记录通过工单关联生产订单
11. ✅ 工单进度通过工单关联生产订单
12. ✅ 工时统计通过工单关联生产订单
13. ✅ 实际成本通过工单关联生产订单（同时有直接关联）
14. ✅ 设备状态通过工单关联生产订单

### ❌ 需要补充（4项）

#### 必需补充（2项）
1. **销售订单表缺少 `production_order_id` 字段**
   - 影响：无法直接关联生产订单，只能通过生产订单的 `source_id` 反向查找
   - 建议：添加 `production_order_id` 字段，支持双向关联

2. **收款单表缺少 `production_order_id` 字段**
   - 影响：无法直接关联生产订单，只能通过销售订单间接关联
   - 建议：添加 `production_order_id` 字段，或扩展收款单明细表的业务类型

#### 建议补充（2项）
3. **生产订单表缺少 `bom_id` 字段**
   - 影响：无法明确记录生产订单使用的具体BOM版本，无法进行版本追溯
   - 建议：添加 `bom_id` 字段，直接关联BOM

4. **生产订单表缺少 `route_id` 字段**
   - 影响：无法明确记录生产订单使用的具体工艺路线版本，无法进行版本追溯
   - 建议：添加 `route_id` 字段，直接关联工艺路线

### 📌 建议

1. **立即执行**：执行上述SQL脚本，添加缺失的关联字段
2. **业务逻辑**：更新相关业务代码，支持新的关联关系
3. **数据迁移**：如果已有数据，需要编写数据迁移脚本，建立历史数据的关联关系
4. **测试验证**：添加关联字段后，需要测试验证关联关系的正确性

---

## 🔍 验证脚本

### 快速验证SQL

执行以下SQL验证字段是否已添加：

```sql
-- 检查销售订单表
SELECT 
    COLUMN_NAME, 
    DATA_TYPE, 
    IS_NULLABLE, 
    COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'erp_sale_order'
    AND COLUMN_NAME = 'production_order_id';

-- 检查收款单表
SELECT 
    COLUMN_NAME, 
    DATA_TYPE, 
    IS_NULLABLE, 
    COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'erp_finance_receipt'
    AND COLUMN_NAME = 'production_order_id';

-- 检查所有生产订单关联字段
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    DATA_TYPE,
    COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
    AND COLUMN_NAME = 'production_order_id'
ORDER BY TABLE_NAME;
```

### 完整验证脚本

已创建完整的验证脚本：`sql/mysql/verify-production-associations.sql`

该脚本包含：
- ✅ 所有包含 `production_order_id` 字段的表的检查
- ✅ 索引完整性检查
- ✅ 必需关联字段的状态检查
- ✅ 间接关联关系检查（通过工单）
- ✅ 关联关系汇总报告

**使用方法**：
```bash
mysql -u用户名 -p数据库名 < sql/mysql/verify-production-associations.sql
```

---

## 📦 数据迁移脚本

### 历史数据关联迁移

**脚本文件**：`sql/mysql/migrate-production-associations.sql`

**功能**：
- 迁移销售订单与生产订单的关联关系（基于生产订单的source_id反向关联）
- 迁移收款单与生产订单的关联关系（通过销售订单间接关联）
- 迁移生产订单的BOM关联（选择产品当前生效的BOM）
- 迁移生产订单的工艺路线关联（选择产品当前生效的工艺路线）
- 显示迁移结果和未关联数据统计

**注意事项**：
1. ⚠️ 执行前请先备份数据库
2. ⚠️ 建议在测试环境先验证
3. ⚠️ 迁移后需要人工审核关联关系的准确性
4. ⚠️ 如果一个销售订单对应多个生产订单，需要手动处理多对多关系

**使用方法**：
```bash
# 1. 先备份数据库
mysqldump -u用户名 -p数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 执行迁移脚本
mysql -u用户名 -p数据库名 < sql/mysql/migrate-production-associations.sql
```

---

*报告生成时间：2024年*  
*检查依据：《生产管理系统完整使用流程.md》*

